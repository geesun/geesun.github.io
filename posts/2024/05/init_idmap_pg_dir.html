<!DOCTYPE html>
<html lang="cn">
<head>
        <meta charset="utf-8" />
        <title>Arm64 Linux 下页表 init_idmap_pg_dir的使用</title>
        <link rel="stylesheet" href="../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../">Linux学习笔记 </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../category/linux.html">Linux</a></li>
                </ul>
                </nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../posts/2024/05/init_idmap_pg_dir.html" rel="bookmark"
           title="Permalink to Arm64 Linux 下页表 init_idmap_pg_dir的使用">Arm64 Linux 下页表 init_idmap_pg_dir的使用</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <span>二 21 五月 2024</span>
<span>| tags: <a href="../../../tag/linux.html">Linux</a></span>
</footer><!-- /.post-info -->      <p>u-boot或者uefi启动kernel的时候，默认MMU是关闭的，所以这个时候kernel实际运行的地址就是物理地址。
为了前期尽早打开MMU和cache，kernel需要建立MMU的页表，这个时候的页表是1:1映射，即VA = PA。</p>
<div class="section" id="section-1">
<h2>分配</h2>
<p>这个页表是在Link 脚本中进行分配，参考代码：</p>
<div class="highlight"><pre><span></span><span class="nf">init_idmap_pg_dir</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="p">.</span><span class="c1">;</span>
<span class="err">.</span><span class="w"> </span><span class="err">+=</span><span class="w"> </span><span class="nf">INIT_IDMAP_DIR_SIZE</span><span class="c1">;</span>
<span class="nf">init_idmap_pg_end</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="p">.</span><span class="c1">;</span>
</pre></div>
<p>至于它的大小INIT_IDMAP_DIR_SIZE 为什么会出现在VA小于48位的时候需要+2个page，+2 表示在基础页数的基础上再增加两个页面的空间，以确保有足够的空间处理对齐、边界和其他可能的额外需求。</p>
<div class="highlight"><pre><span></span><span class="cp">#if VA_BITS &lt; 48</span>
<span class="cp">#define INIT_IDMAP_DIR_SIZE     ((INIT_IDMAP_DIR_PAGES + 2) * PAGE_SIZE)</span>
<span class="cp">#else</span>
<span class="cp">#define INIT_IDMAP_DIR_SIZE     (INIT_IDMAP_DIR_PAGES * PAGE_SIZE)</span>
<span class="cp">#endif</span>
</pre></div>
</div>
<div class="section" id="section-2">
<h2>创建</h2>
<p>在函数create_idmap 会创建从_text 到 _end + MAX_FDT_SIZE + SWAPPER_BLOCK_SIZE 的1:1映射。
从启动到正式的页表建立之前，kernel是不会访问写任何数据，除了写device tree 和正式的页表。
所以默认把它映射成SWAPPER_RX_MMUFLAGS。然后再把FDT和init_pg_dir 的region 设置成SWAPPER_RW_MMUFLAGS度。</p>
<p>建立完成之后，在__enable_mmu 会去使能MMU，同时
TTBR0 = init_idmap_pg_dir
TTBR1 = reserved_pg_dir</p>
<p>MMU的页表如下：</p>
<div class="highlight"><pre><span></span>&gt;mmu<span class="w"> </span>print<span class="w"> </span>EL1N_S1_TTBR0_EL1<span class="w"> </span><span class="nv">TTBR0_EL1</span><span class="o">=</span>init_idmap_pg_dir
Input<span class="w"> </span>Address<span class="w">   </span><span class="p">|</span><span class="w"> </span>Type<span class="w">           </span><span class="p">|</span><span class="w"> </span>Next<span class="w"> </span>Level<span class="w">            </span><span class="p">|</span><span class="w"> </span>Output<span class="w"> </span>Address<span class="w">        </span><span class="p">|</span><span class="w"> </span>Properties
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
+<span class="w"> </span>0x00000000<span class="w">    </span><span class="p">|</span><span class="w"> </span>TTBR0_EL1<span class="w">      </span><span class="p">|</span><span class="w"> </span>NP:0x0000000085A90000<span class="w"> </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span><span class="nv">TBI1</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">TBI0</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">AS</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">IPS</span><span class="o">=</span>256TB,<span class="w"> </span><span class="nv">TG1</span><span class="o">=</span>4KB,<span class="w"> </span><span class="nv">SH1</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">ORGN1</span><span class="o">=</span>0x1,<span class="w"> </span><span class="nv">IRGN1</span><span class="o">=</span>0x1,<span class="w"> </span><span class="nv">EPD1</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">A1</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">T1SZ</span><span class="o">=</span><span class="m">16</span>,<span class="w"> </span><span class="nv">TG0</span><span class="o">=</span>4KB,<span class="w"> </span><span class="nv">SH0</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">ORGN0</span><span class="o">=</span>0x1,<span class="w"> </span><span class="nv">IRGN0</span><span class="o">=</span>0x1,<span class="w"> </span><span class="nv">EPD0</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">T0SZ</span><span class="o">=</span><span class="m">16</span>,<span class="w"> </span><span class="nv">HPD1</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">HPD0</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">HD</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">HA</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">CnP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">ASID</span><span class="o">=</span><span class="m">0</span>
<span class="w"> </span>+<span class="w"> </span>0x00000000<span class="w">   </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">0</span><span class="w"> </span>Table<span class="w">  </span><span class="p">|</span><span class="w"> </span>NP:0x0000000085A91000<span class="w"> </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span><span class="nv">APTable</span><span class="o">=</span>0x0,<span class="w"> </span><span class="nv">UXNTable</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXNTable</span><span class="o">=</span><span class="m">0</span>
<span class="w">  </span>-<span class="w"> </span>0x00000000<span class="w">  </span><span class="p">|</span><span class="w"> </span>Invalid<span class="w">        </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span>
<span class="w">  </span>-<span class="w"> </span>0x40000000<span class="w">  </span><span class="p">|</span><span class="w"> </span>Invalid<span class="w">        </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span>
<span class="w">  </span>+<span class="w"> </span>0x80000000<span class="w">  </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">1</span><span class="w"> </span>Table<span class="w">  </span><span class="p">|</span><span class="w"> </span>NP:0x0000000085A92000<span class="w"> </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span><span class="nv">APTable</span><span class="o">=</span>0x0,<span class="w"> </span><span class="nv">UXNTable</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXNTable</span><span class="o">=</span><span class="m">0</span>
<span class="w">   </span>-<span class="w"> </span>0x80000000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Invalid<span class="w"> </span><span class="o">(</span>x32<span class="o">)</span><span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span>
<span class="w">   </span>-<span class="w"> </span>0x84000000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000084000000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x2,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0x84200000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000084200000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x2,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0x84400000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000084400000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x2,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0x84600000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000084600000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x2,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0x84800000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000084800000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x2,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0x84A00000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000084A00000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x2,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0x84C00000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000084C00000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x2,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0x84E00000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000084E00000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x2,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0x85000000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000085000000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x2,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0x85200000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000085200000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x2,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0x85400000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000085400000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x2,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0x85600000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000085600000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x2,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0x85800000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000085800000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x2,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0x85A00000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000085A00000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x2,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0x85C00000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000085C00000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x2,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0x85E00000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000085E00000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x2,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0x86000000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000086000000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x2,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0x86200000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000086200000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x2,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0x86400000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000086400000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x0,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0x86600000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000082000000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x0,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0x86800000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000082200000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x0,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0x86A00000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Invalid<span class="w"> </span><span class="o">(</span>x459<span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span>
<span class="w">  </span>-<span class="w"> </span>0xC0000000<span class="w">  </span><span class="p">|</span><span class="w"> </span>Invalid<span class="w"> </span><span class="o">(</span>x509<span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span>
<span class="w"> </span>-<span class="w"> </span>0x8000000000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Invalid<span class="w"> </span><span class="o">(</span>x511<span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span>
</pre></div>
</div>
<div class="section" id="ttbr1">
<h2>设置TTBR1</h2>
<p>这个时候TTBR1还是指向reserved_pg_dir，为了建立正式的VA到PA的映射，在函数：create_kernel_mapping 中会把整个kernel image 建立VA 到PA的映射：</p>
<div class="highlight"><pre><span></span><span class="nf">SYM_FUNC_START_LOCAL</span><span class="p">(</span><span class="no">create_kernel_mapping</span><span class="p">)</span>
<span class="w">        </span><span class="nf">adrp</span><span class="w">    </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">init_pg_dir</span>
<span class="w">        </span><span class="nf">mov_q</span><span class="w">   </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">KIMAGE_VADDR</span><span class="w">                </span><span class="c1">// compile time __va(_text)</span>
<span class="c1">#ifdef CONFIG_RELOCATABLE</span>
<span class="w">        </span><span class="nf">add</span><span class="w">     </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x23</span><span class="w">                     </span><span class="c1">// add KASLR displacement</span>
<span class="c1">#endif</span>
<span class="w">        </span><span class="nf">adrp</span><span class="w">    </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">_end</span><span class="w">                        </span><span class="c1">// runtime __pa(_end)</span>
<span class="w">        </span><span class="nf">adrp</span><span class="w">    </span><span class="no">x3</span><span class="p">,</span><span class="w"> </span><span class="no">_text</span><span class="w">                       </span><span class="c1">// runtime __pa(_text)</span>
<span class="w">        </span><span class="nf">sub</span><span class="w">     </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span><span class="w">                      </span><span class="c1">// _end - _text</span>
<span class="w">        </span><span class="nf">add</span><span class="w">     </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="w">                      </span><span class="c1">// runtime __va(_end)</span>
<span class="w">        </span><span class="nf">mov_q</span><span class="w">   </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">SWAPPER_RW_MMUFLAGS</span>

<span class="w">        </span><span class="nf">map_memory</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x5</span><span class="p">,</span><span class="w"> </span><span class="no">x6</span><span class="p">,</span><span class="w"> </span><span class="no">x7</span><span class="p">,</span><span class="w"> </span><span class="no">x3</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="no">VA_BITS</span><span class="w"> </span><span class="p">-</span><span class="w"> </span><span class="no">PGDIR_SHIFT</span><span class="p">),</span><span class="w"> </span><span class="no">x10</span><span class="p">,</span><span class="w"> </span><span class="no">x11</span><span class="p">,</span><span class="w"> </span><span class="no">x12</span><span class="p">,</span><span class="w"> </span><span class="no">x13</span><span class="p">,</span><span class="w"> </span><span class="no">x14</span>

<span class="w">        </span><span class="nf">dsb</span><span class="w">     </span><span class="no">ishst</span><span class="w">                           </span><span class="c1">// sync with page table walker</span>
<span class="w">        </span><span class="nf">ret</span>
<span class="nf">SYM_FUNC_END</span><span class="p">(</span><span class="no">create_kernel_mapping</span><span class="p">)</span>
</pre></div>
<p>因为这个也不是最终的页表，所以我们看到属性全都设置成了SWAPPER_RW_MMUFLAGS。 后面这个页表会被swapper_pg_dir 给替换掉。
TTBR的MMU的页表如下：</p>
<div class="highlight"><pre><span></span>&gt;mmu<span class="w"> </span>print<span class="w"> </span>EL1N_S1_TTBR1_EL1<span class="w"> </span><span class="nv">TTBR1_EL1</span><span class="o">=</span>init_pg_dir
Input<span class="w"> </span>Address<span class="w">           </span><span class="p">|</span><span class="w"> </span>Type<span class="w">           </span><span class="p">|</span><span class="w"> </span>Next<span class="w"> </span>Level<span class="w">            </span><span class="p">|</span><span class="w"> </span>Output<span class="w"> </span>Address<span class="w">        </span><span class="p">|</span><span class="w"> </span>Properties
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
+<span class="w"> </span>0xFFFF000000000000<span class="w">    </span><span class="p">|</span><span class="w"> </span>TTBR1_EL1<span class="w">      </span><span class="p">|</span><span class="w"> </span>NP:0x00000000865DA000<span class="w"> </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span><span class="nv">TBI1</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">TBI0</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">AS</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">IPS</span><span class="o">=</span>256TB,<span class="w"> </span><span class="nv">TG1</span><span class="o">=</span>4KB,<span class="w"> </span><span class="nv">SH1</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">ORGN1</span><span class="o">=</span>0x1,<span class="w"> </span><span class="nv">IRGN1</span><span class="o">=</span>0x1,<span class="w"> </span><span class="nv">EPD1</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">A1</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">T1SZ</span><span class="o">=</span><span class="m">16</span>,<span class="w"> </span><span class="nv">TG0</span><span class="o">=</span>4KB,<span class="w"> </span><span class="nv">SH0</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">ORGN0</span><span class="o">=</span>0x1,<span class="w"> </span><span class="nv">IRGN0</span><span class="o">=</span>0x1,<span class="w"> </span><span class="nv">EPD0</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">T0SZ</span><span class="o">=</span><span class="m">16</span>,<span class="w"> </span><span class="nv">HPD1</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">HPD0</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">HD</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">HA</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">CnP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">ASID</span><span class="o">=</span><span class="m">0</span>
<span class="w"> </span>-<span class="w"> </span>0xFFFF000000000000<span class="w">   </span><span class="p">|</span><span class="w"> </span>Invalid<span class="w"> </span><span class="o">(</span>x256<span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span>
<span class="w"> </span>+<span class="w"> </span>0xFFFF800000000000<span class="w">   </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">0</span><span class="w"> </span>Table<span class="w">  </span><span class="p">|</span><span class="w"> </span>NP:0x00000000865DB000<span class="w"> </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span><span class="nv">APTable</span><span class="o">=</span>0x0,<span class="w"> </span><span class="nv">UXNTable</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXNTable</span><span class="o">=</span><span class="m">0</span>
<span class="w">  </span>+<span class="w"> </span>0xFFFF800000000000<span class="w">  </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">1</span><span class="w"> </span>Table<span class="w">  </span><span class="p">|</span><span class="w"> </span>NP:0x00000000865DC000<span class="w"> </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span><span class="nv">APTable</span><span class="o">=</span>0x0,<span class="w"> </span><span class="nv">UXNTable</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXNTable</span><span class="o">=</span><span class="m">0</span>
<span class="w">   </span>-<span class="w"> </span>0xFFFF800000000000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Invalid<span class="w"> </span><span class="o">(</span>x64<span class="o">)</span><span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span>
<span class="w">   </span>-<span class="w"> </span>0xFFFF800008000000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000084000000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x0,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0xFFFF800008200000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000084200000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x0,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0xFFFF800008400000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000084400000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x0,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0xFFFF800008600000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000084600000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x0,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0xFFFF800008800000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000084800000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x0,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0xFFFF800008A00000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000084A00000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x0,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0xFFFF800008C00000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000084C00000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x0,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0xFFFF800008E00000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000084E00000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x0,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0xFFFF800009000000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000085000000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x0,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0xFFFF800009200000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000085200000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x0,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0xFFFF800009400000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000085400000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x0,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0xFFFF800009600000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000085600000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x0,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0xFFFF800009800000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000085800000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x0,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0xFFFF800009A00000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000085A00000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x0,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0xFFFF800009C00000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000085C00000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x0,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0xFFFF800009E00000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000085E00000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x0,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0xFFFF80000A000000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000086000000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x0,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0xFFFF80000A200000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000086200000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x0,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0xFFFF80000A400000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Level<span class="w"> </span><span class="m">2</span><span class="w"> </span>Block<span class="w">  </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w"> </span>NP:0x0000000086400000<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">UXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">PXN</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">Contiguous</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">DBM</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">GP</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">nG</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">AF</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">SH</span><span class="o">=</span>0x3,<span class="w"> </span><span class="nv">AP</span><span class="o">=</span>0x0,<span class="w"> </span><span class="nv">AttrIndx</span><span class="o">=</span>0x0
<span class="w">   </span>-<span class="w"> </span>0xFFFF80000A600000<span class="w"> </span><span class="p">|</span><span class="w"> </span>Invalid<span class="w"> </span><span class="o">(</span>x429<span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span>
<span class="w">  </span>-<span class="w"> </span>0xFFFF800040000000<span class="w">  </span><span class="p">|</span><span class="w"> </span>Invalid<span class="w"> </span><span class="o">(</span>x511<span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span>
<span class="w"> </span>-<span class="w"> </span>0xFFFF808000000000<span class="w">   </span><span class="p">|</span><span class="w"> </span>Invalid<span class="w"> </span><span class="o">(</span>x255<span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span><span class="w">                       </span><span class="p">|</span>
</pre></div>
</div>
<div class="section" id="init-idmap-pg-dir">
<h2>卸载init_idmap_pg_dir</h2>
<p>在函数__primary_switch，kernel会从1:1 的VA 切换到正式的真正的VA：</p>
<div class="highlight"><pre><span></span><span class="nf">SYM_FUNC_START_LOCAL</span><span class="p">(</span><span class="no">__primary_switch</span><span class="p">)</span>
<span class="w">        </span><span class="nf">adrp</span><span class="w">    </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">reserved_pg_dir</span>
<span class="w">        </span><span class="nf">adrp</span><span class="w">    </span><span class="no">x2</span><span class="p">,</span><span class="w"> </span><span class="no">init_idmap_pg_dir</span>
<span class="w">        </span><span class="nf">bl</span><span class="w">      </span><span class="no">__enable_mmu</span>
<span class="c1">#ifdef CONFIG_RELOCATABLE</span>
<span class="w">        </span><span class="nf">adrp</span><span class="w">    </span><span class="no">x23</span><span class="p">,</span><span class="w"> </span><span class="no">KERNEL_START</span>
<span class="w">        </span><span class="nf">and</span><span class="w">     </span><span class="no">x23</span><span class="p">,</span><span class="w"> </span><span class="no">x23</span><span class="p">,</span><span class="w"> </span><span class="no">MIN_KIMG_ALIGN</span><span class="w"> </span><span class="p">-</span><span class="w"> </span><span class="mi">1</span>
<span class="c1">#ifdef CONFIG_RANDOMIZE_BASE</span>
<span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x22</span>
<span class="w">        </span><span class="nf">adrp</span><span class="w">    </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">init_pg_end</span>
<span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span>
<span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">x29</span><span class="p">,</span><span class="w"> </span><span class="no">xzr</span>
<span class="w">        </span><span class="nf">bl</span><span class="w">      </span><span class="no">__pi_kaslr_early_init</span>
<span class="w">        </span><span class="nf">and</span><span class="w">     </span><span class="no">x24</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="c1">#SZ_2M - 1             // capture memstart offset seed</span>
<span class="w">        </span><span class="nf">bic</span><span class="w">     </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="c1">#SZ_2M - 1</span>
<span class="w">        </span><span class="nf">orr</span><span class="w">     </span><span class="no">x23</span><span class="p">,</span><span class="w"> </span><span class="no">x23</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="w">                    </span><span class="c1">// record kernel offset</span>
<span class="c1">#endif</span>
<span class="c1">#endif</span>
<span class="w">        </span><span class="nf">bl</span><span class="w">      </span><span class="no">clear_page_tables</span>
<span class="w">        </span><span class="nf">bl</span><span class="w">      </span><span class="no">create_kernel_mapping</span>

<span class="w">        </span><span class="nf">adrp</span><span class="w">    </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">init_pg_dir</span>
<span class="w">        </span><span class="nf">load_ttbr1</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x2</span>
<span class="c1">#ifdef CONFIG_RELOCATABLE</span>
<span class="w">        </span><span class="nf">bl</span><span class="w">      </span><span class="no">__relocate_kernel</span>
<span class="c1">#endif</span>
<span class="w">        </span><span class="nf">ldr</span><span class="w">     </span><span class="no">x8</span><span class="p">,</span><span class="w"> </span><span class="err">=</span><span class="no">__primary_switched</span>
<span class="w">        </span><span class="nf">adrp</span><span class="w">    </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">KERNEL_START</span><span class="w">                </span><span class="c1">// __pa(KERNEL_START)</span>
<span class="w">        </span><span class="nf">br</span><span class="w">      </span><span class="no">x8</span>
<span class="nf">SYM_FUNC_END</span><span class="p">(</span><span class="no">__primary_switch</span><span class="p">)</span>
</pre></div>
<p>这个时候1:1 的mapping就基本不用了，就在setup_arch函数调用cpu_uninstall_idmap把TTBR0设置成reserved_pg_dir</p>
<div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">cpu_uninstall_idmap</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">active_mm</span><span class="p">;</span>

<span class="w">        </span><span class="n">cpu_set_reserved_ttbr0</span><span class="p">();</span>
<span class="w">        </span><span class="n">local_flush_tlb_all</span><span class="p">();</span>
<span class="w">        </span><span class="n">cpu_set_default_tcr_t0sz</span><span class="p">();</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mm</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">init_mm</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">system_uses_ttbr0_pan</span><span class="p">())</span>
<span class="w">                </span><span class="n">cpu_switch_mm</span><span class="p">(</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">pgd</span><span class="p">,</span><span class="w"> </span><span class="n">mm</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>接下还会在paging_init 的里面使用 init_idmap_pg_dir，因为我们要切换MMU页表，不能直接使用TTBR1映射的函数，需要使用idmap的函数才能切换TTBR1所对应的页表。 参考函数：</p>
<div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">__cpu_replace_ttbr1</span><span class="p">(</span><span class="n">pgd_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdp</span><span class="p">,</span><span class="w"> </span><span class="n">pgd_t</span><span class="w"> </span><span class="o">*</span><span class="n">idmap</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">cnp</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="k">typedef</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="n">ttbr_replace_func</span><span class="p">)(</span><span class="n">phys_addr_t</span><span class="p">);</span>
<span class="w">        </span><span class="k">extern</span><span class="w"> </span><span class="n">ttbr_replace_func</span><span class="w"> </span><span class="n">idmap_cpu_replace_ttbr1</span><span class="p">;</span>
<span class="w">        </span><span class="n">ttbr_replace_func</span><span class="w"> </span><span class="o">*</span><span class="n">replace_phys</span><span class="p">;</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">daif</span><span class="p">;</span>

<span class="w">        </span><span class="cm">/* phys_to_ttbr() zeros lower 2 bits of ttbr with 52-bit PA */</span>
<span class="w">        </span><span class="n">phys_addr_t</span><span class="w"> </span><span class="n">ttbr1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phys_to_ttbr</span><span class="p">(</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">pgdp</span><span class="p">));</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cnp</span><span class="p">)</span>
<span class="w">                </span><span class="n">ttbr1</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">TTBR_CNP_BIT</span><span class="p">;</span>

<span class="w">        </span><span class="n">replace_phys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">__pa_symbol</span><span class="p">(</span><span class="n">idmap_cpu_replace_ttbr1</span><span class="p">);</span>

<span class="w">        </span><span class="n">__cpu_install_idmap</span><span class="p">(</span><span class="n">idmap</span><span class="p">);</span>

<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         * We really don&#39;t want to take *any* exceptions while TTBR1 is</span>
<span class="cm">         * in the process of being replaced so mask everything.</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="n">daif</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_daif_save</span><span class="p">();</span>
<span class="w">        </span><span class="n">replace_phys</span><span class="p">(</span><span class="n">ttbr1</span><span class="p">);</span>
<span class="w">        </span><span class="n">local_daif_restore</span><span class="p">(</span><span class="n">daif</span><span class="p">);</span>

<span class="w">        </span><span class="n">cpu_uninstall_idmap</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="init-idmap-pg-dir-1">
<h2>回收init_idmap_pg_dir</h2>
<p>init_idmap_pg_dir 这个页表使用完了不是立即就回收利用，这部分内存是从__init_begin 到__init_end 的一部分，所以在系统初始化结束之后，统一进行回收利用。
在函数 kernel_init-&gt;free_initmem</p>
<div class="highlight"><pre><span></span><span class="n">__init_begin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.;</span>
<span class="c1">//...</span>
<span class="n">init_idmap_pg_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.;</span>
<span class="p">.</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">INIT_IDMAP_DIR_SIZE</span><span class="p">;</span>
<span class="n">init_idmap_pg_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.;</span>
<span class="c1">//.....</span>
<span class="p">.</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALIGN</span><span class="p">(</span><span class="n">SEGMENT_ALIGN</span><span class="p">);</span>
<span class="n">__initdata_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.;</span>
<span class="n">__init_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.;</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">free_initmem</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">        </span><span class="n">free_reserved_area</span><span class="p">(</span><span class="n">lm_alias</span><span class="p">(</span><span class="n">__init_begin</span><span class="p">),</span>
<span class="w">                           </span><span class="n">lm_alias</span><span class="p">(</span><span class="n">__init_end</span><span class="p">),</span>
<span class="w">                           </span><span class="n">POISON_FREE_INITMEM</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;unused kernel&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         * Unmap the __init region but leave the VM area in place. This</span>
<span class="cm">         * prevents the region from being reused for kernel modules, which</span>
<span class="cm">         * is not supported by kallsyms.</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="n">vunmap_range</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">__init_begin</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">__init_end</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>参考：</p>
<p><a class="reference external" href="https://lore.kernel.org/all/20220624150651.1358849-13-ardb&#64;kernel.org/">[kernel patch]</a></p>
</div>

    </div><!-- /.entry-content -->
    <div class="comments">
      <h2>Comments !</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_identifier = "posts/2024/05/init_idmap_pg_dir.html";
        var disqus_url = "https://geesun.github.io/posts/2024/05/init_idmap_pg_dir.html";
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//geesun.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
    </div>

  </article>
</section>

        <footer id="contentinfo" class="body">
                <p>&copy; 2024 Qixiang Xu</p>
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'geesun';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>