<!DOCTYPE html>
<html lang="cn">
<head>
        <meta charset="utf-8" />
        <title>如何使用ArmDS调试动态加载的Linux kernel模块</title>
        <link rel="stylesheet" href="../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../">Linux学习笔记 </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../category/linux.html">Linux</a></li>
                </ul>
                </nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../posts/2024/07/03_debug_kernel_module.html" rel="bookmark"
           title="Permalink to 如何使用ArmDS调试动态加载的Linux kernel模块">如何使用ArmDS调试动态加载的Linux kernel模块</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <span>二 23 七月 2024</span>
<span>| tags: <a href="../../../tag/linux.html">Linux</a><a href="../../../tag/debug.html">Debug</a></span>
</footer><!-- /.post-info -->      <p>根据Arm Development Studio User Guide的 <a class="reference external" href="https://developer.arm.com/documentation/101470/2024-0/Debugging-Embedded-Systems/About-OS-awareness/About-debugging-Linux-kernel-modules">About debugging Linux kernel modules</a> ,ArmDS是可以调试动态加载的Linux kernel 模块。 但是需要ArmDS支持你所使用的kernel版本，ArmDS支持的版本可以参考Arm Development Studio User Guide的 <a class="reference external" href="https://developer.arm.com/documentation/101470/2024-0/Debugging-Embedded-Systems/About-OS-awareness">About OS awareness</a></p>
<p>可以看到这里支持的版本非常有限，如果使用的kernel不在上面的列表里面，那就没有办法用上面的方法调试了。</p>
<p>ArmDS的实现的原理我猜估计也是使用linux kernel里面提供的模块加载信息，然后再把模块的符号表加载到对应的位置。</p>
<p>下面的步骤就是介绍如何在不使用ArmDS提供的OS信息的情况下如何调试动态加载的kernel的模块。</p>
<div class="section" id="kernel">
<h2>1. 准备要调试的kernel模块</h2>
<p>假设这里有如下模块的代码 mod_debug_test.c：</p>
<div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/module.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/printk.h&gt;</span>

<span class="cp">#define MODULE_NAME &quot;mod_debug_test&quot;</span>

<span class="n">__attribute__</span><span class="p">((</span><span class="n">__noinline__</span><span class="p">))</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">mod_debug_test_func</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>

<span class="w">    </span><span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="n">mod_debug_test_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">);</span>
<span class="w">    </span><span class="n">mod_debug_test_func</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__exit</span><span class="w"> </span><span class="n">mod_debug_test_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">mod_debug_test_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">mod_debug_test_exit</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
</pre></div>
<p>在同样目录下面，有Makefile：</p>
<div class="highlight"><pre><span></span>obj-m<span class="w"> </span>+<span class="o">=</span><span class="w"> </span>mod_debug_test.o
<span class="nv">DEBUG_CFLAGS</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span>-g
<span class="nv">CC</span><span class="o">=</span>/workspace/tools/clang+llvm-18.1.8-x86_64-linux-gnu-ubuntu-18.04/bin/clang
<span class="nv">CROSS_COMPILE</span><span class="o">=</span>/workspace/tools/arm-gnu-toolchain-13.2.Rel1-x86_64-aarch64-none-linux-gnu/bin/aarch64-none-linux-gnu-
<span class="nv">LINUX_DIR</span><span class="o">=</span>/workspace/src/linux
all:
<span class="w">        </span>make<span class="w"> </span>-C<span class="w"> </span><span class="k">$(</span>LINUX_DIR<span class="k">)</span><span class="w">  </span><span class="nv">ARCH</span><span class="o">=</span>arm64<span class="w"> </span><span class="nv">CC</span><span class="o">=</span><span class="k">$(</span>CC<span class="k">)</span><span class="w"> </span><span class="nv">CROSS_COMPILE</span><span class="o">=</span><span class="k">$(</span>CROSS_COMPILE<span class="k">)</span><span class="w">  </span><span class="nv">M</span><span class="o">=</span><span class="k">$(</span>PWD<span class="k">)</span><span class="w"> </span>modules<span class="w">  </span><span class="nv">EXTRA_CFLAGS</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>DEBUG_CFLAGS<span class="k">)</span><span class="s2">&quot;</span>

clean:
<span class="w">        </span>make<span class="w"> </span>-C<span class="w"> </span><span class="k">$(</span>LINUX_DIR<span class="k">)</span><span class="w">  </span><span class="nv">ARCH</span><span class="o">=</span>arm64<span class="w"> </span><span class="nv">CC</span><span class="o">=</span><span class="k">$(</span>CC<span class="k">)</span><span class="w"> </span><span class="nv">CROSS_COMPILE</span><span class="o">=</span><span class="k">$(</span>CROSS_COMPILE<span class="k">)</span><span class="w">  </span><span class="nv">M</span><span class="o">=</span><span class="k">$(</span>PWD<span class="k">)</span><span class="w">  </span><span class="nv">EXTRA_CFLAGS</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>DEBUG_CFLAGS<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span>clean
</pre></div>
<p>这里为了能够在ko里面带有debug符号表信息，所以就需要有 -g 选项。</p>
</div>
<div class="section" id="kernel-modulesection">
<h2>2. kernel module相关的section</h2>
<p>这里可以通过objdump来查看要调试的kernel module 有多少的section，我们要调试的代码处在哪个section中。如下：</p>
<blockquote>
<div class="highlight"><pre><span></span><span class="err">~/</span><span class="nf">workspace</span><span class="err">/</span><span class="no">src</span><span class="err">/</span><span class="no">testmod$</span><span class="w"> </span><span class="no">aarch64-none-linux-gnu-objdump</span><span class="w">  </span><span class="p">-</span><span class="no">S</span><span class="w"> </span><span class="no">mod_debug_test.ko</span>

<span class="nl">mod_debug_test.ko:</span><span class="w">     </span><span class="nf">file</span><span class="w"> </span><span class="no">format</span><span class="w"> </span><span class="no">elf64-littleaarch64</span>


<span class="nf">Disassembly</span><span class="w"> </span><span class="no">of</span><span class="w"> </span><span class="no">section</span><span class="w"> </span><span class="no">.text</span><span class="p">:</span>

<span class="err">0000000000000000</span><span class="w"> </span><span class="err">&lt;</span><span class="nf">mod_debug_test_func</span><span class="err">&gt;</span><span class="p">:</span>
<span class="c1">#include &lt;linux/printk.h&gt;</span>

<span class="c1">#define MODULE_NAME &quot;mod_debug_test&quot;</span>

<span class="nf">__attribute__</span><span class="p">((</span><span class="no">__noinline__</span><span class="p">))</span><span class="w"> </span><span class="no">static</span><span class="w"> </span><span class="no">void</span><span class="w"> </span><span class="no">mod_debug_test_func</span><span class="p">(</span><span class="no">void</span><span class="w"> </span><span class="p">)</span>
<span class="err">{</span>
<span class="w">   </span><span class="err">0:</span><span class="w">   </span><span class="nf">d503233f</span><span class="w">        </span><span class="no">paciasp</span>
<span class="w">   </span><span class="err">4:</span><span class="w">   </span><span class="nf">a9bf7bfd</span><span class="w">        </span><span class="no">stp</span><span class="w">     </span><span class="no">x29</span><span class="p">,</span><span class="w"> </span><span class="no">x30</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">#-16</span><span class="p">]!</span>
<span class="w">   </span><span class="err">8:</span><span class="w">   </span><span class="err">910003</span><span class="nf">fd</span><span class="w">        </span><span class="no">mov</span><span class="w">     </span><span class="no">x29</span><span class="p">,</span><span class="w"> </span><span class="no">sp</span>

<span class="w">    </span><span class="nf">pr_info</span><span class="p">(</span><span class="err">&quot;</span><span class="nv">%s</span><span class="w"> </span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span><span class="no">__FUNCTION__</span><span class="p">)</span><span class="c1">;</span>
<span class="w">   </span><span class="nl">c:</span><span class="w">   </span><span class="err">90000000</span><span class="w">        </span><span class="nf">adrp</span><span class="w">    </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="mh">0</span> <span class="p">&lt;</span><span class="no">mod_debug_test_func</span><span class="p">&gt;</span>
<span class="w">  </span><span class="err">10:</span><span class="w">   </span><span class="err">91000000</span><span class="w">        </span><span class="nf">add</span><span class="w">     </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="mi">#0</span><span class="no">x0</span>
<span class="w">  </span><span class="err">14:</span><span class="w">   </span><span class="err">90000001</span><span class="w">        </span><span class="nf">adrp</span><span class="w">    </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mh">0</span> <span class="p">&lt;</span><span class="no">mod_debug_test_func</span><span class="p">&gt;</span>
<span class="w">  </span><span class="err">18:</span><span class="w">   </span><span class="err">91000021</span><span class="w">        </span><span class="nf">add</span><span class="w">     </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">#0</span><span class="no">x0</span>
<span class="w">  </span><span class="err">1</span><span class="nl">c:</span><span class="w">   </span><span class="err">94000000</span><span class="w">        </span><span class="nf">bl</span><span class="w">      </span><span class="mh">0</span> <span class="p">&lt;</span><span class="no">_printk</span><span class="p">&gt;</span>
<span class="err">}</span>
<span class="w">  </span><span class="err">20:</span><span class="w">   </span><span class="nf">a8c17bfd</span><span class="w">        </span><span class="no">ldp</span><span class="w">     </span><span class="no">x29</span><span class="p">,</span><span class="w"> </span><span class="no">x30</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">],</span><span class="w"> </span><span class="mi">#16</span>
<span class="w">  </span><span class="err">24:</span><span class="w">   </span><span class="nf">d50323bf</span><span class="w">        </span><span class="no">autiasp</span>
<span class="w">  </span><span class="err">28:</span><span class="w">   </span><span class="nf">d65f03c0</span><span class="w">        </span><span class="no">ret</span>

<span class="nf">Disassembly</span><span class="w"> </span><span class="no">of</span><span class="w"> </span><span class="no">section</span><span class="w"> </span><span class="no">.init.text</span><span class="p">:</span>

<span class="err">0000000000000000</span><span class="w"> </span><span class="err">&lt;</span><span class="nf">init_module</span><span class="err">&gt;</span><span class="p">:</span>
<span class="nf">static</span><span class="w"> </span><span class="no">int</span><span class="w"> </span><span class="no">__init</span><span class="w"> </span><span class="no">mod_debug_test_init</span><span class="p">(</span><span class="no">void</span><span class="p">)</span>
<span class="err">{</span>
<span class="w">   </span><span class="err">0:</span><span class="w">   </span><span class="nf">d503233f</span><span class="w">        </span><span class="no">paciasp</span>
<span class="w">   </span><span class="err">4:</span><span class="w">   </span><span class="nf">a9bf7bfd</span><span class="w">        </span><span class="no">stp</span><span class="w">     </span><span class="no">x29</span><span class="p">,</span><span class="w"> </span><span class="no">x30</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">#-16</span><span class="p">]!</span>
<span class="w">   </span><span class="err">8:</span><span class="w">   </span><span class="err">910003</span><span class="nf">fd</span><span class="w">        </span><span class="no">mov</span><span class="w">     </span><span class="no">x29</span><span class="p">,</span><span class="w"> </span><span class="no">sp</span>
<span class="w">    </span><span class="nf">pr_info</span><span class="p">(</span><span class="err">&quot;</span><span class="nv">%s</span><span class="w"> </span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span><span class="no">__FUNCTION__</span><span class="p">)</span><span class="c1">;</span>
<span class="w">   </span><span class="nl">c:</span><span class="w">   </span><span class="err">90000000</span><span class="w">        </span><span class="nf">adrp</span><span class="w">    </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="mh">0</span> <span class="p">&lt;</span><span class="no">init_module</span><span class="p">&gt;</span>
<span class="w">  </span><span class="err">10:</span><span class="w">   </span><span class="err">91000000</span><span class="w">        </span><span class="nf">add</span><span class="w">     </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="mi">#0</span><span class="no">x0</span>
<span class="w">  </span><span class="err">14:</span><span class="w">   </span><span class="err">90000001</span><span class="w">        </span><span class="nf">adrp</span><span class="w">    </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mh">0</span> <span class="p">&lt;</span><span class="no">init_module</span><span class="p">&gt;</span>
<span class="w">  </span><span class="err">18:</span><span class="w">   </span><span class="err">91000021</span><span class="w">        </span><span class="nf">add</span><span class="w">     </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">#0</span><span class="no">x0</span>
<span class="w">  </span><span class="err">1</span><span class="nl">c:</span><span class="w">   </span><span class="err">94000000</span><span class="w">        </span><span class="nf">bl</span><span class="w">      </span><span class="mh">0</span> <span class="p">&lt;</span><span class="no">_printk</span><span class="p">&gt;</span>
<span class="w">    </span><span class="nf">mod_debug_test_func</span><span class="p">()</span><span class="c1">;</span>
<span class="w">  </span><span class="err">20:</span><span class="w">   </span><span class="err">94000000</span><span class="w">        </span><span class="nf">bl</span><span class="w">      </span><span class="mh">0</span> <span class="p">&lt;</span><span class="no">init_module</span><span class="p">&gt;</span>
<span class="w">    </span><span class="nf">return</span><span class="w"> </span><span class="mi">0</span><span class="c1">;</span>
<span class="w">  </span><span class="err">24:</span><span class="w">   </span><span class="err">2</span><span class="nf">a1f03e0</span><span class="w">        </span><span class="no">mov</span><span class="w">     </span><span class="no">w0</span><span class="p">,</span><span class="w"> </span><span class="no">wzr</span>
<span class="w">  </span><span class="err">28:</span><span class="w">   </span><span class="nf">a8c17bfd</span><span class="w">        </span><span class="no">ldp</span><span class="w">     </span><span class="no">x29</span><span class="p">,</span><span class="w"> </span><span class="no">x30</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">],</span><span class="w"> </span><span class="mi">#16</span>
<span class="w">  </span><span class="err">2</span><span class="nl">c:</span><span class="w">   </span><span class="nf">d50323bf</span><span class="w">        </span><span class="no">autiasp</span>
<span class="w">  </span><span class="err">30:</span><span class="w">   </span><span class="nf">d65f03c0</span><span class="w">        </span><span class="no">ret</span>

<span class="nf">Disassembly</span><span class="w"> </span><span class="no">of</span><span class="w"> </span><span class="no">section</span><span class="w"> </span><span class="no">.exit.text</span><span class="p">:</span>

<span class="err">0000000000000000</span><span class="w"> </span><span class="err">&lt;</span><span class="nf">cleanup_module</span><span class="err">&gt;</span><span class="p">:</span>
<span class="err">}</span>

<span class="nf">static</span><span class="w"> </span><span class="no">void</span><span class="w"> </span><span class="no">__exit</span><span class="w"> </span><span class="no">mod_debug_test_exit</span><span class="p">(</span><span class="no">void</span><span class="p">)</span>
<span class="err">{</span>
<span class="w">   </span><span class="err">0:</span><span class="w">   </span><span class="nf">d503233f</span><span class="w">        </span><span class="no">paciasp</span>
<span class="w">   </span><span class="err">4:</span><span class="w">   </span><span class="nf">a9bf7bfd</span><span class="w">        </span><span class="no">stp</span><span class="w">     </span><span class="no">x29</span><span class="p">,</span><span class="w"> </span><span class="no">x30</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">,</span><span class="w"> </span><span class="mi">#-16</span><span class="p">]!</span>
<span class="w">   </span><span class="err">8:</span><span class="w">   </span><span class="err">910003</span><span class="nf">fd</span><span class="w">        </span><span class="no">mov</span><span class="w">     </span><span class="no">x29</span><span class="p">,</span><span class="w"> </span><span class="no">sp</span>
<span class="w">    </span><span class="nf">pr_info</span><span class="p">(</span><span class="err">&quot;</span><span class="nv">%s</span><span class="w"> </span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span><span class="no">__FUNCTION__</span><span class="p">)</span><span class="c1">;</span>
<span class="w">   </span><span class="nl">c:</span><span class="w">   </span><span class="err">90000000</span><span class="w">        </span><span class="nf">adrp</span><span class="w">    </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="mh">0</span> <span class="p">&lt;</span><span class="no">cleanup_module</span><span class="p">&gt;</span>
<span class="w">  </span><span class="err">10:</span><span class="w">   </span><span class="err">91000000</span><span class="w">        </span><span class="nf">add</span><span class="w">     </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="no">x0</span><span class="p">,</span><span class="w"> </span><span class="mi">#0</span><span class="no">x0</span>
<span class="w">  </span><span class="err">14:</span><span class="w">   </span><span class="err">90000001</span><span class="w">        </span><span class="nf">adrp</span><span class="w">    </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mh">0</span> <span class="p">&lt;</span><span class="no">cleanup_module</span><span class="p">&gt;</span>
<span class="w">  </span><span class="err">18:</span><span class="w">   </span><span class="err">91000021</span><span class="w">        </span><span class="nf">add</span><span class="w">     </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="no">x1</span><span class="p">,</span><span class="w"> </span><span class="mi">#0</span><span class="no">x0</span>
<span class="w">  </span><span class="err">1</span><span class="nl">c:</span><span class="w">   </span><span class="err">94000000</span><span class="w">        </span><span class="nf">bl</span><span class="w">      </span><span class="mh">0</span> <span class="p">&lt;</span><span class="no">_printk</span><span class="p">&gt;</span>
<span class="err">}</span>
<span class="w">  </span><span class="err">20:</span><span class="w">   </span><span class="nf">a8c17bfd</span><span class="w">        </span><span class="no">ldp</span><span class="w">     </span><span class="no">x29</span><span class="p">,</span><span class="w"> </span><span class="no">x30</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">sp</span><span class="p">],</span><span class="w"> </span><span class="mi">#16</span>
<span class="w">  </span><span class="err">24:</span><span class="w">   </span><span class="nf">d50323bf</span><span class="w">        </span><span class="no">autiasp</span>
<span class="w">  </span><span class="err">28:</span><span class="w">   </span><span class="nf">d65f03c0</span><span class="w">        </span><span class="no">ret</span>

<span class="nf">Disassembly</span><span class="w"> </span><span class="no">of</span><span class="w"> </span><span class="no">section</span><span class="w"> </span><span class="no">.plt</span><span class="p">:</span>

<span class="err">0000000000000000</span><span class="w"> </span><span class="err">&lt;</span><span class="na">.plt</span><span class="err">&gt;</span><span class="p">:</span>
<span class="w">        </span><span class="na">...</span>

<span class="nf">Disassembly</span><span class="w"> </span><span class="no">of</span><span class="w"> </span><span class="no">section</span><span class="w"> </span><span class="no">.text.ftrace_trampoline</span><span class="p">:</span>

<span class="err">0000000000000000</span><span class="w"> </span><span class="err">&lt;</span><span class="na">.text.ftrace_trampoline</span><span class="err">&gt;</span><span class="p">:</span>
<span class="na">...</span>
</pre></div>
</blockquote>
<p>通过观察，text section主要分成三个， .text  .init.text 和 .exit.text， 其他的section跟这里的调试关系不大，暂时可以忽略。</p>
<p>而每个section的地址都是在insmod的时候，通过 module_memory_alloc-&gt; module_alloc -&gt; __vmalloc_node_range 来分配。</p>
<p>所以每次分配的VA地址是根据系统使用的情况来决定，每次可能分配VA的地址可能是不一样的。</p>
</div>
<div class="section" id="kernel-module-section">
<h2>3. kernel module section 加载地址</h2>
<p>在kernel module加载到系统之后，可以通过查看/sys/module/&lt;mod_name&gt;/sections 下面module加载的信息知道每个section的VA地址，如下：</p>
<div class="highlight"><pre><span></span><span class="c1"># cat /sys/module/mod_debug_test/sections/.text</span>
0xffff80007ab40000
<span class="c1"># cat /sys/module/mod_debug_test/sections/.init.text</span>
0xffff80007ab46000
<span class="c1"># cat /sys/module/mod_debug_test/sections/.exit.text</span>
0xffff80007ab4002c
</pre></div>
<p>但是这样的方式找section的加载地址，是有些限制的，就是必须的等到module加载到系统之后才能找到这些section的地址。 可是module init相关的代码，是在module 加载完成之前就已经运行完成了。</p>
<p>如果想要调试module init相关代码，可能需要在module加载完成之前找到它对应的 .init.text section的加载地址。</p>
<p>在do_init_module 函数的时候，系统已经调用了vmalloc的接口给每个section分配了对应的VA。</p>
<p>这样就可以分析struct module的的信息找到对应的section地址。</p>
<div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">module</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="cm">/* Unique handle for this module */</span>
<span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="n">MODULE_NAME_LEN</span><span class="p">];</span>

<span class="w">        </span><span class="cm">/* Startup function. */</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">init</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>

<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">module_memory</span><span class="w"> </span><span class="n">mem</span><span class="p">[</span><span class="n">MOD_MEM_NUM_TYPES</span><span class="p">]</span><span class="w"> </span><span class="n">__module_memory_align</span><span class="p">;</span>


<span class="k">enum</span><span class="w"> </span><span class="n">mod_mem_type</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">MOD_TEXT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">        </span><span class="n">MOD_DATA</span><span class="p">,</span>
<span class="w">        </span><span class="n">MOD_RODATA</span><span class="p">,</span>
<span class="w">        </span><span class="n">MOD_RO_AFTER_INIT</span><span class="p">,</span>
<span class="w">        </span><span class="n">MOD_INIT_TEXT</span><span class="p">,</span>
<span class="w">        </span><span class="n">MOD_INIT_DATA</span><span class="p">,</span>
<span class="w">        </span><span class="n">MOD_INIT_RODATA</span><span class="p">,</span>

<span class="w">        </span><span class="n">MOD_MEM_NUM_TYPES</span><span class="p">,</span>
<span class="w">        </span><span class="n">MOD_INVALID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
<p>这个时候需要先把断点设在do_init_module 函数，来查看module-&gt;mem[x].base找到对应的section 加载的地址。 如下：</p>
<div class="highlight"><pre><span></span>&gt;bt
<span class="c1">#0 do_init_module(mod = (struct module*) 0xFFFF80007AB42040) at main.c:2510</span>
<span class="c1">#1 load_module(info = &lt;Value currently has no location&gt;, uargs = 0xAAAADAF0F2A0 &quot;&quot;, flags = 0) at main.c:3001</span>
<span class="c1">#2 init_module_from_file(f = (struct file*) 0xFFFF00080017B200, uargs = 0xAAAADAF0F2A0 &quot;&quot;, flags = 0) at main.c:3168</span>
<span class="c1">#3 hash_64_generic(val = &lt;Value currently has no location&gt;, bits = &lt;Value currently has no location&gt;) at hash.h:78</span>
<span class="c1">#4 __do_sys_finit_module(fd = &lt;Value currently has no location&gt;, uargs = &lt;Value currently has no location&gt;, flags = &lt;Value currently has no location&gt;) at spinlock.h:0</span>
<span class="c1">#5 __arm64_sys_finit_module(regs ERROR(CMD367-IMG96):</span>
!<span class="w"> </span>Error<span class="w"> </span>computing<span class="w"> </span>the<span class="w"> </span>variable<span class="w"> </span><span class="s2">&quot;regs&quot;</span>
!<span class="w"> </span>Unimplemented<span class="w"> </span>DWARF<span class="w"> </span>opcode<span class="w"> </span>0xa3
<span class="o">)</span><span class="w"> </span>at<span class="w"> </span>file.h:0
<span class="c1">#6 __invoke_syscall(regs = (struct pt_regs*) 0xFFFF8000834FBEB0, syscall_fn = &lt;Value currently has no location&gt;) at syscall.c:0</span>
<span class="c1">#7 __kern_my_cpu_offset() at percpu.h:40</span>
<span class="c1">#8 read_ti_thread_flags(ti = &lt;Value optimised away by compiler&gt;) at thread_info.h:127</span>
<span class="c1">#9 el0_svc_common(regs = (struct pt_regs*) 0xFFFF8000834FBEB0, scno = &lt;Value currently has no location&gt;, sc_nr = 462, syscall_table ERROR(CMD367-IMG96):</span>
!<span class="w"> </span>Error<span class="w"> </span>computing<span class="w"> </span>the<span class="w"> </span>variable<span class="w"> </span><span class="s2">&quot;syscall_table&quot;</span>
!<span class="w"> </span>Unimplemented<span class="w"> </span>DWARF<span class="w"> </span>opcode<span class="w"> </span>0xa3
<span class="o">)</span><span class="w"> </span>at<span class="w"> </span>syscall.c:142
<span class="c1">#10 do_el0_svc(regs ERROR(CMD367-IMG96):</span>
!<span class="w"> </span>Error<span class="w"> </span>computing<span class="w"> </span>the<span class="w"> </span>variable<span class="w"> </span><span class="s2">&quot;regs&quot;</span>
!<span class="w"> </span>Unimplemented<span class="w"> </span>DWARF<span class="w"> </span>opcode<span class="w"> </span>0xa3
<span class="o">)</span><span class="w"> </span>at<span class="w"> </span>syscall.c:153
<span class="c1">#11 exit_to_user_mode_prepare(regs = (struct pt_regs*) 0xFFFF8000834FBEB0) at entry-common.c:165</span>
<span class="c1">#12 el0_da(regs = &lt;Value not available : Undefined value in stack frame for register X0&gt;, esr = &lt;Value not available : Undefined value in stack frame for register X1&gt;) at entry-common.c:575</span>
<span class="c1">#13 el0t_64_sync_handler(regs ERROR(CMD367-IMG96):</span>
!<span class="w"> </span>Error<span class="w"> </span>computing<span class="w"> </span>the<span class="w"> </span>variable<span class="w"> </span><span class="s2">&quot;regs&quot;</span>
!<span class="w"> </span>Unimplemented<span class="w"> </span>DWARF<span class="w"> </span>opcode<span class="w"> </span>0xa3
<span class="o">)</span><span class="w"> </span>at<span class="w"> </span>entry-common.c:0
&gt;p/x<span class="w"> </span>mod-&gt;mem<span class="o">[</span><span class="m">0</span><span class="o">]</span>.base
<span class="nv">$11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>void*<span class="o">)</span><span class="w"> </span>0xFFFF80007AB40000
&gt;p/x<span class="w"> </span>mod-&gt;mem<span class="o">[</span><span class="m">4</span><span class="o">]</span>.base
<span class="nv">$12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>void*<span class="o">)</span><span class="w"> </span>0xFFFF80007AB46000
</pre></div>
<p>这样的方式也可以找到.text 和.init.text section 加载的地址。</p>
</div>
<div class="section" id="armdskernel-module">
<h2>4. 在ArmDS中加载kernel module符号表</h2>
<p>如果把ko文件直接加载到ArmDS中的话，会出现如下错误：</p>
<div class="highlight"><pre><span></span>&gt;add-symbol-file<span class="w"> </span>src/testmod/mod_debug_test.ko
ERROR<span class="o">(</span>CMD685-COR11-COR236<span class="o">)</span>:
!<span class="w"> </span>Failed<span class="w"> </span>to<span class="w"> </span>load<span class="w"> </span>symbols<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="s2">&quot;mod_debug_test.ko&quot;</span>
!<span class="w"> </span>Failed<span class="w"> </span>to<span class="w"> </span><span class="nb">read</span><span class="w"> </span>the<span class="w"> </span>symbols<span class="w"> </span>from<span class="w"> </span>src/testmod/mod_debug_test.ko
!<span class="w"> </span>Unable<span class="w"> </span>to<span class="w"> </span><span class="nb">read</span><span class="w"> </span>OS<span class="w"> </span>module<span class="w"> </span>symbols,<span class="w"> </span>OS<span class="w"> </span>support<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>yet<span class="w"> </span>active.
</pre></div>
<p>这是因为ArmDS检测到是ko的时候，会走一个特殊的路径来加载KO的符号表。所以不能用简单的命令来加载，这里需要把单独的section加载到它对应的地址，命令如下：</p>
<div class="highlight"><pre><span></span>&gt;add-symbol-file<span class="w"> </span>src/testmod/mod_debug_test.ko<span class="w">  </span>-s<span class="w"> </span>.init.text<span class="w">  </span>0xFFFF80007AB46000<span class="w"> </span>-s<span class="w"> </span>.text<span class="w"> </span>0xFFFF80007AB40000<span class="w"> </span>-s<span class="w"> </span>.exit.text<span class="w"> </span>0xffff80007ab4002c
</pre></div>
<p>或者你只需要加载一个section的符号表，可以使用下面的命令：</p>
<div class="highlight"><pre><span></span>&gt;add-symbol-file<span class="w"> </span>src/testmod/mod_debug_test.ko<span class="w">  </span>-s<span class="w"> </span>.init.text<span class="w">  </span>0xFFFF80007AB46000
</pre></div>
<p>解下来就可以正常设置断点，开始调试了。</p>
<div class="highlight"><pre><span></span>&gt;break<span class="w"> </span>mod_debug_test_init
Breakpoint<span class="w"> </span><span class="m">4</span><span class="w"> </span>at<span class="w"> </span>EL2N:0xFFFF80007AB46000
<span class="w">    </span>on<span class="w"> </span>file<span class="w"> </span>mod_debug_test.c,<span class="w"> </span>line<span class="w"> </span><span class="m">12</span>
&gt;break<span class="w"> </span>mod_debug_test_func
Breakpoint<span class="w"> </span><span class="m">5</span><span class="w"> </span>at<span class="w"> </span>EL2N:0xFFFF80007AB40000
<span class="w">    </span>on<span class="w"> </span>file<span class="w"> </span>mod_debug_test.c,<span class="w"> </span>line<span class="w"> </span><span class="m">7</span>
&gt;break<span class="w"> </span>mod_debug_test_exit
Breakpoint<span class="w"> </span><span class="m">6</span><span class="w"> </span>at<span class="w"> </span>EL2N:0xFFFF80007AB4002C
<span class="w">    </span>on<span class="w"> </span>file<span class="w"> </span>mod_debug_test.c,<span class="w"> </span>line<span class="w"> </span><span class="m">19</span>
&gt;c
Execution<span class="w"> </span>stopped<span class="w"> </span><span class="k">in</span><span class="w"> </span>EL2h<span class="w"> </span>mode<span class="w"> </span>at<span class="w"> </span>breakpoint<span class="w"> </span><span class="m">4</span>:<span class="w"> </span>EL2N:0xFFFF80007AB46000
On<span class="w"> </span>core<span class="w"> </span>ARM_AEM-A_MP_0<span class="w"> </span><span class="o">(</span>ID<span class="w"> </span><span class="m">0</span><span class="o">)</span>
In<span class="w"> </span>mod_debug_test.c
EL2N:0xFFFF80007AB46000<span class="w">   </span><span class="m">12</span>,0<span class="w">   </span><span class="o">{</span>
&gt;l
<span class="w">  </span><span class="m">007</span>:<span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="m">008</span>:
<span class="w">  </span><span class="m">009</span>:<span class="w">     </span>pr_info<span class="o">(</span><span class="s2">&quot;%s \n&quot;</span>,__FUNCTION__<span class="o">)</span><span class="p">;</span>
<span class="w">  </span><span class="m">010</span>:<span class="w"> </span><span class="o">}</span>
<span class="w">  </span><span class="m">011</span>:<span class="w"> </span>static<span class="w"> </span>int<span class="w"> </span>__init<span class="w"> </span>mod_debug_test_init<span class="o">(</span>void<span class="o">)</span>
*<span class="w"> </span><span class="m">012</span>:<span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="m">013</span>:<span class="w">     </span>pr_info<span class="o">(</span><span class="s2">&quot;%s \n&quot;</span>,__FUNCTION__<span class="o">)</span><span class="p">;</span>
<span class="w">  </span><span class="m">014</span>:<span class="w">     </span>mod_debug_test_func<span class="o">()</span><span class="p">;</span>
<span class="w">  </span><span class="m">015</span>:<span class="w">     </span><span class="k">return</span><span class="w"> </span><span class="m">0</span><span class="p">;</span>
<span class="w">  </span><span class="m">016</span>:<span class="w"> </span><span class="o">}</span>
&gt;c
Execution<span class="w"> </span>stopped<span class="w"> </span><span class="k">in</span><span class="w"> </span>EL2h<span class="w"> </span>mode<span class="w"> </span>at<span class="w"> </span>breakpoint<span class="w"> </span><span class="m">5</span>:<span class="w"> </span>EL2N:0xFFFF80007AB40000
On<span class="w"> </span>core<span class="w"> </span>ARM_AEM-A_MP_0<span class="w"> </span><span class="o">(</span>ID<span class="w"> </span><span class="m">0</span><span class="o">)</span>
EL2N:0xFFFF80007AB40000<span class="w">   </span><span class="m">7</span>,0<span class="w">   </span><span class="o">{</span>
&gt;l
<span class="w">  </span><span class="m">002</span>:<span class="w"> </span><span class="c1">#include &lt;linux/printk.h&gt;</span>
<span class="w">  </span><span class="m">003</span>:
<span class="w">  </span><span class="m">004</span>:<span class="w"> </span><span class="c1">#define MODULE_NAME &quot;mod_debug_test&quot;</span>
<span class="w">  </span><span class="m">005</span>:
<span class="w">  </span><span class="m">006</span>:<span class="w"> </span>__attribute__<span class="o">((</span>__noinline__<span class="o">))</span><span class="w"> </span>static<span class="w"> </span>void<span class="w"> </span>mod_debug_test_func<span class="o">(</span>void<span class="w"> </span><span class="o">)</span>
*<span class="w"> </span><span class="m">007</span>:<span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="m">008</span>:
<span class="w">  </span><span class="m">009</span>:<span class="w">     </span>pr_info<span class="o">(</span><span class="s2">&quot;%s \n&quot;</span>,__FUNCTION__<span class="o">)</span><span class="p">;</span>
<span class="w">  </span><span class="m">010</span>:<span class="w"> </span><span class="o">}</span>
<span class="w">  </span><span class="m">011</span>:<span class="w"> </span>static<span class="w"> </span>int<span class="w"> </span>__init<span class="w"> </span>mod_debug_test_init<span class="o">(</span>void<span class="o">)</span>
&gt;c
Execution<span class="w"> </span>stopped<span class="w"> </span><span class="k">in</span><span class="w"> </span>EL2h<span class="w"> </span>mode<span class="w"> </span>at<span class="w"> </span>breakpoint<span class="w"> </span><span class="m">6</span>:<span class="w"> </span>EL2N:0xFFFF80007AB4002C
On<span class="w"> </span>core<span class="w"> </span>ARM_AEM-A_MP_2<span class="w"> </span><span class="o">(</span>ID<span class="w"> </span><span class="m">2</span><span class="o">)</span>
EL2N:0xFFFF80007AB4002C<span class="w">   </span><span class="m">19</span>,0<span class="w">   </span><span class="o">{</span>
&gt;l
<span class="w">  </span><span class="m">014</span>:<span class="w">     </span>mod_debug_test_func<span class="o">()</span><span class="p">;</span>
<span class="w">  </span><span class="m">015</span>:<span class="w">     </span><span class="k">return</span><span class="w"> </span><span class="m">0</span><span class="p">;</span>
<span class="w">  </span><span class="m">016</span>:<span class="w"> </span><span class="o">}</span>
<span class="w">  </span><span class="m">017</span>:
<span class="w">  </span><span class="m">018</span>:<span class="w"> </span>static<span class="w"> </span>void<span class="w"> </span>__exit<span class="w"> </span>mod_debug_test_exit<span class="o">(</span>void<span class="o">)</span>
*<span class="w"> </span><span class="m">019</span>:<span class="w"> </span><span class="o">{</span>
<span class="w">  </span><span class="m">020</span>:<span class="w">     </span>pr_info<span class="o">(</span><span class="s2">&quot;%s \n&quot;</span>,__FUNCTION__<span class="o">)</span><span class="p">;</span>
<span class="w">  </span><span class="m">021</span>:<span class="w"> </span><span class="o">}</span>
<span class="w">  </span><span class="m">022</span>:<span class="w"> </span>module_init<span class="o">(</span>mod_debug_test_init<span class="o">)</span><span class="p">;</span>
<span class="w">  </span><span class="m">023</span>:<span class="w"> </span>module_exit<span class="o">(</span>mod_debug_test_exit<span class="o">)</span><span class="p">;</span>
</pre></div>
</div>

    </div><!-- /.entry-content -->
    <div class="comments">
      <h2>Comments !</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_identifier = "posts/2024/07/03_debug_kernel_module.html";
        var disqus_url = "https://geesun.github.io/posts/2024/07/03_debug_kernel_module.html";
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//geesun.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
    </div>

  </article>
</section>

        <footer id="contentinfo" class="body">
                <p>&copy; 2024 Qixiang Xu</p>
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'geesun';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>