<!DOCTYPE html>
<html lang="cn">
<head>
        <meta charset="utf-8" />
        <title>Linux学习笔记 - Linux</title>
        <link rel="stylesheet" href="../theme/css/main.css" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../">Linux学习笔记 </a></h1>
                <nav><ul>
                    <li class="active"><a href="../category/linux.html">Linux</a></li>
                </ul>
                </nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="../posts/2024/08/04_kdump_crash_kernel.html">如何使用Kdump来分析crash kernel</a></h1>
<footer class="post-info">
        <span>四 01 八月 2024</span>
<span>| tags: <a href="../tag/linux.html">Linux</a><a href="../tag/debug.html">Debug</a></span>
</footer><!-- /.post-info --><p>根据Linux Kernel <a class="reference external" href="https://www.kernel.org/doc/Documentation/kdump/kdump.txt">Kdump</a> 文档，可以使用如下工具在Host上分析kernel crash的现场</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/horms/kexec-tools">kexec-tools</a>  - 交叉编译在Target系统上，打包进正常rootfs里面</li>
<li><a class="reference external" href="https://github.com/makedumpfile/makedumpfile">makedumpfile</a> - 交叉编译在Target系统上，打包进crash系统的rootfs里面</li>
<li><a class="reference external" href="https://github.com/crash-utility/crash">crash-utility</a> - 使用Host编译，target=ARM64，在Host里面使用</li>
</ul>
<p>根据Kdump的文档，需要准备两个kernel和两个文件系统。</p>
<ul>
<li><p class="first">两个Linux Kernel</p>
<blockquote>
<ul class="simple">
<li>System kernel - 正常使用的的Linux kernel</li>
<li>Dump-capture kernel  - 当正常使用的kernel出现crash的时候，需要运行这个kernel来获取正常使用kernel的运行状态。</li>
</ul>
</blockquote>
</li>
<li><p class="first">两个文件系统</p>
<blockquote>
<ul class="simple">
<li>正常rootfs，需要包含kexec-tools，当kernel crash的时候，需要借助kexec 来运行 Dump-capture kernel</li>
<li>Dump-capture 文件系统，可以是一个很小的文件系统，主要是把crash 的core 文件dump出来，可以包含工具makedumpfile。</li>
</ul>
</blockquote>
</li>
</ul>
<div class="section" id="section-1">
<h2>注意事项</h2>
<p>这里有一些要特别注意的，这里这些工具的版本和Linux kernel版本可能是强关联的，根据实际测试的结果，使用最新的Linux(v6.9)和这些工具就不太兼容。下面是这里使用的版本信息：</p>
<ul class="simple">
<li>Linux kernel - v6.8</li>
<li>kexec-tools - v2.0.29</li>
<li>makedumpfile - v1.7.5</li>
<li>crash-utility - v8.0.5</li>
</ul>
</div>
<div class="section" id="linux-kernel">
<h2>Linux kernel 配置</h2>
<p>前面提到这里需要使用两个kernel，一个系统System kernel 和一个Dump-capture kernel。 System kernel 如果要是用kdump的话，需要有如下配置：</p>
<div class="highlight"><pre><span></span><span class="n">CONFIG_KEXEC</span><span class="o">=</span><span class="n">y</span>
<span class="n">CONFIG_SYSFS</span><span class="o">=</span><span class="n">y</span>
<span class="n">CONFIG_DEBUG_INFO</span><span class="o">=</span><span class="n">Y</span>
</pre></div>
<p>如果要使用crash-utility来分析kernel dump的结果，这里还需要去掉一个配置：</p>
<div class="highlight"><pre><span></span><span class="cp"># CONFIG_DEBUG_INFO_REDUCED is not set</span>
</pre></div>
<p>否则使用crash的时候会出新如下错误：</p>
<div class="highlight"><pre><span></span>Type<span class="w"> </span><span class="s2">&quot;apropos word&quot;</span><span class="w"> </span>to<span class="w"> </span>search<span class="w"> </span><span class="k">for</span><span class="w"> </span>commands<span class="w"> </span>related<span class="w"> </span>to<span class="w"> </span><span class="s2">&quot;word&quot;</span>...

WARNING:<span class="w"> </span><span class="nv">CONFIG_DEBUG_INFO_REDUCED</span><span class="o">=</span>y
crash:<span class="w"> </span>../linux/vmlinux:<span class="w"> </span>no<span class="w"> </span>debugging<span class="w"> </span>data<span class="w"> </span>available

crash:<span class="w"> </span>neither<span class="w"> </span>runqueue<span class="w"> </span>nor<span class="w"> </span>rq<span class="w"> </span>structures<span class="w"> </span>exist
</pre></div>
<p>Dump-capture kernel 它的主要目的是把/proc/vmcore里面的信息复制到host系统里面，所以这个kernel跟System kernel比起来，就不需要太多的配置。 下面这些是必须要有的配置：</p>
<div class="highlight"><pre><span></span><span class="n">CONFIG_CRASH_DUMP</span><span class="o">=</span><span class="n">y</span>
<span class="n">CONFIG_PROC_VMCORE</span><span class="o">=</span><span class="n">y</span>
<span class="n">CONFIG_RELOCATABLE</span><span class="o">=</span><span class="n">y</span>
</pre></div>
<p>当然System kernel 和Dump-capture kernel也可以使用同一个配置。 但在实际的系统里面，应该会使用不同的配置，因为肯定希望Dump-capture kernel使用更少的资源。包括只boot一个CPU就可以了。</p>
<p>System kernel之前在什么地址运行，这里还可以使用之前的配置。没有额外的更改。 但是Dump-capture kernel 在什么地址运行，这里需要我们指定。这也就是需要在boot command里面指定：</p>
<div class="highlight"><pre><span></span><span class="n">CONFIG_BOOTARGS</span><span class="o">=</span><span class="s">&quot;console=ttyAMA0 earlycon=pl011,0x1c090000 root=/dev/vda1 rw ip=dhcp debug loglevel=9 crashkernel=512M &quot;</span>
</pre></div>
<p>可以看到在正常系统boot的时候，会给reserved一段内存给Dump-capture kernel来使用。</p>
<div class="highlight"><pre><span></span><span class="c1">#0 __parse_crashkernel(cmdline = 0xFFFF800081C85008 &quot;console=ttyAMA0 earlycon=pl011,0x1c090000 root=/dev/vda1 rw ip=dhcp debug loglevel=9 crashkernel=512M crash_kexec_post_notifiers=1&quot;, system_ram = 4278190080, crash_size = (long long unsigned int*) 0xFFFF800082523D30, crash_base = (long lo</span>
ng<span class="w"> </span>unsigned<span class="w"> </span>int*<span class="o">)</span><span class="w"> </span>0xFFFF800082523D28,<span class="w"> </span><span class="nv">suffix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>const<span class="w"> </span>char*<span class="o">)</span><span class="w"> </span>0x0<span class="o">)</span><span class="w"> </span>at<span class="w"> </span>crash_core.c:269
<span class="c1">#1 parse_crashkernel(cmdline = 0xFFFF800081C85008 &quot;console=ttyAMA0 earlycon=pl011,0x1c090000 root=/dev/vda1 rw ip=dhcp debug loglevel=9 crashkernel=512M crash_kexec_post_notifiers=1&quot;,</span>
,<span class="w"> </span><span class="nv">crash_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>long<span class="w"> </span>long<span class="w"> </span>unsigned<span class="w"> </span>int*<span class="o">)</span><span class="w"> </span>0xFFFF800082523D30,<span class="w"> </span><span class="nv">crash_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>long<span class="w"> </span>long<span class="w"> </span>unsigned<span class="w"> </span>int*<span class="o">)</span><span class="w"> </span>0xFFFF800082523D28,<span class="w"> </span><span class="nv">low_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>long<span class="w"> </span>long<span class="w"> </span>unsigned<span class="w"> </span>int*<span class="o">)</span><span class="w"> </span>0xFFFF800082523D20,<span class="w"> </span><span class="nv">high</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>0xFFFF800082523D1F<span class="w"> </span><span class="s2">&quot;&quot;</span><span class="o">)</span><span class="w"> </span>at<span class="w"> </span>crash_core.c:324
<span class="c1">#2 arch_reserve_crashkernel() at init.c:109</span>
<span class="c1">#3 bootmem_init() at init.c:112</span>
<span class="c1">#4 request_standard_resources() at setup.c:359</span>
<span class="c1">#5 get_boot_config_from_initrd(_size = (size_t*) 0x0) at main.c:898</span>
<span class="c1">#6 setup_command_line(command_line = (char*) 0x0) at main.c:634</span>
<span class="c1">#7 __primary_switched() at head.S:524</span>
</pre></div>
<p>至于要给预留多大，主要是看Dump-capture kernel的配置，因为我们这里使用同一个kernel 配置，所有预留的比较大。</p>
<p>最后系统解析完成之后会把结果放到如下变量， 当使用kexec load Dump-capture kernel，就是从这里去找空间。</p>
<div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">resource</span><span class="w"> </span><span class="n">crashk_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Crash kernel&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">end</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IORESOURCE_BUSY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">IORESOURCE_SYSTEM_RAM</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">desc</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">IORES_DESC_CRASH_KERNEL</span>
<span class="p">};</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">resource</span><span class="w"> </span><span class="n">crashk_low_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Crash kernel&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">end</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IORESOURCE_BUSY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">IORESOURCE_SYSTEM_RAM</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">desc</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">IORES_DESC_CRASH_KERNEL</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="section" id="section-2">
<h2>文件系统</h2>
<p>这里使用buildroot来制作文件系统，因为buildroot里面已经支持了kexec-tools 和makedumpfile，所以只需要加上这两个配置就可以：</p>
<div class="highlight"><pre><span></span><span class="n">BR2_PACKAGE_KEXEC</span><span class="o">=</span><span class="n">y</span>
<span class="n">BR2_PACKAGE_KEXEC_ZLIB</span><span class="o">=</span><span class="n">y</span>

<span class="n">BR2_PACKAGE_MAKEDUMPFILE</span><span class="o">=</span><span class="n">y</span>
</pre></div>
<p>如果两个系统使用不同的rootfs，这个时候在正常系统里面加上kexec-tools，在Dump-capture 系统里面加上makedumpfile这两个包就可以。</p>
<p>为了能够加载 Dump-capture系统，这里就需要把Dump-capture Linux kernel 的Image 放在正常系统的rootfs里面。 下面的实验就把Image放在 /root/Image。</p>
<p>这里为了实验简单，就使用同一个文件系统。</p>
<p>为了把kernel crash 后的core dump 数据复制出来，下面的实验是把core dump的数据复制到文件系统，然后在复制到host系统。 所以需要给rootfs预留比较大的空闲空间。</p>
<p>如果系统里面使用网络的话，就可以通过网络的方式把core dump 数据复制出来。这应该有很多手段，这个怎么方便可以怎么来。</p>
</div>
<div class="section" id="dump-capture-kernel">
<h2>Dump-capture kernel 加载</h2>
<p>准备好两个系统之后，可以正常情况加载系统。 只是在u-boot 的Linux boot commands 需要加上：</p>
<div class="highlight"><pre><span></span><span class="n">CONFIG_BOOTARGS</span><span class="o">=</span><span class="s">&quot;console=ttyAMA0 earlycon=pl011,0x1c090000 root=/dev/vda1 rw ip=dhcp debug loglevel=9 crashkernel=512M &quot;</span>
</pre></div>
<p>系统boot 成功之后，可以看到有如下打印：</p>
<div class="highlight"><pre><span></span><span class="p">[</span><span class="w">    </span><span class="mf">0.000000</span><span class="p">]</span><span class="w"> </span><span class="n">crashkernel</span><span class="w"> </span><span class="n">reserved</span><span class="o">:</span><span class="w"> </span><span class="mh">0x00000000db600000</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0x00000000fb600000</span><span class="w"> </span><span class="p">(</span><span class="mi">512</span><span class="w"> </span><span class="n">MB</span><span class="p">)</span>
</pre></div>
<p>这里为Dump-capture Linux kernel 预留了这部分物理地址。</p>
<p>因为Dump-capture Linux kernel 已经放在/root/Image 里面了，接下来就可以在目标系统使用如下命令加载Dump-capture Linux kernel 上面那个地址：</p>
<div class="highlight"><pre><span></span>kexec<span class="w"> </span>-p<span class="w"> </span>/root/Image<span class="w"> </span>--reuse-cmdline<span class="w">  </span>--append<span class="o">=</span><span class="s2">&quot;maxcpus=1 reset_devices&quot;</span>
</pre></div>
<p>执行结果如下：</p>
<div class="highlight"><pre><span></span><span class="c1"># kexec -p /root/Image --reuse-cmdline  --append=&quot;maxcpus=1 reset_devices&quot; -d</span>
kernel<span class="w"> </span>symbol<span class="w"> </span>_text<span class="w"> </span><span class="nv">vaddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ffff800080000000
kernel<span class="w"> </span>symbol<span class="w"> </span>_stext<span class="w"> </span><span class="nv">vaddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ffff800080010000
kernel<span class="w"> </span>symbol<span class="w"> </span>__init_begin<span class="w"> </span><span class="nv">vaddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ffff800081b80000
arch_process_options:178:<span class="w"> </span>command_line:<span class="w"> </span><span class="nv">console</span><span class="o">=</span>ttyAMA0<span class="w"> </span><span class="nv">earlycon</span><span class="o">=</span>pl011,0x1c090000<span class="w"> </span><span class="nv">root</span><span class="o">=</span>/dev/vda1<span class="w"> </span>rw<span class="w"> </span><span class="nv">ip</span><span class="o">=</span>dhcp<span class="w"> </span>debug<span class="w"> </span><span class="nv">loglevel</span><span class="o">=</span><span class="m">9</span><span class="w">  </span><span class="nv">maxcpus</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>reset_devices
arch_process_options:180:<span class="w"> </span>initrd:<span class="w"> </span><span class="o">(</span>null<span class="o">)</span>
arch_process_options:182:<span class="w"> </span>dtb:<span class="w"> </span><span class="o">(</span>null<span class="o">)</span>
arch_process_options:185:<span class="w"> </span>console:<span class="w"> </span><span class="o">(</span>null<span class="o">)</span>
Try<span class="w"> </span>gzip<span class="w"> </span>decompression.
Try<span class="w"> </span>LZMA<span class="w"> </span>decompression.
elf_arm64_probe:<span class="w"> </span>Not<span class="w"> </span>an<span class="w"> </span>ELF<span class="w"> </span>executable.
<span class="o">[</span><span class="w"> </span><span class="m">8103</span>.741670<span class="o">]</span><span class="w"> </span>kernel:<span class="w"> </span><span class="o">(</span>____ptrval____<span class="o">)</span><span class="w"> </span>kernel_size:<span class="w"> </span>0x29b2200
<span class="o">[</span><span class="w"> </span><span class="m">8103</span>.741816<span class="o">]</span><span class="w"> </span>Crash<span class="w"> </span>PT_LOAD<span class="w"> </span>ELF<span class="w"> </span>header.<span class="w"> </span><span class="nv">phdr</span><span class="o">=(</span>____ptrval____<span class="o">)</span><span class="w"> </span><span class="nv">vaddr</span><span class="o">=</span>0xffff000000000000,<span class="w"> </span><span class="nv">paddr</span><span class="o">=</span>0x80000000,<span class="w"> </span><span class="nv">sz</span><span class="o">=</span>0x5b600000<span class="w"> </span><span class="nv">e_phnum</span><span class="o">=</span><span class="m">11</span><span class="w"> </span><span class="nv">p_offset</span><span class="o">=</span>0x80000000
<span class="o">[</span><span class="w"> </span><span class="m">8103</span>.741981<span class="o">]</span><span class="w"> </span>Crash<span class="w"> </span>PT_LOAD<span class="w"> </span>ELF<span class="w"> </span>header.<span class="w"> </span><span class="nv">phdr</span><span class="o">=(</span>____ptrval____<span class="o">)</span><span class="w"> </span><span class="nv">vaddr</span><span class="o">=</span>0xffff00007b600000,<span class="w"> </span><span class="nv">paddr</span><span class="o">=</span>0xfb600000,<span class="w"> </span><span class="nv">sz</span><span class="o">=</span>0x3a00000<span class="w"> </span><span class="nv">e_phnum</span><span class="o">=</span><span class="m">12</span><span class="w"> </span><span class="nv">p_offset</span><span class="o">=</span>0xfb600000
<span class="o">[</span><span class="w"> </span><span class="m">8103</span>.742145<span class="o">]</span><span class="w"> </span>Crash<span class="w"> </span>PT_LOAD<span class="w"> </span>ELF<span class="w"> </span>header.<span class="w"> </span><span class="nv">phdr</span><span class="o">=(</span>____ptrval____<span class="o">)</span><span class="w"> </span><span class="nv">vaddr</span><span class="o">=</span>0xffff000800000000,<span class="w"> </span><span class="nv">paddr</span><span class="o">=</span>0x880000000,<span class="w"> </span><span class="nv">sz</span><span class="o">=</span>0x80000000<span class="w"> </span><span class="nv">e_phnum</span><span class="o">=</span><span class="m">13</span><span class="w"> </span><span class="nv">p_offset</span><span class="o">=</span>0x880000000
<span class="o">[</span><span class="w"> </span><span class="m">8103</span>.742315<span class="o">]</span><span class="w"> </span>Loaded<span class="w"> </span>elf<span class="w"> </span>core<span class="w"> </span>header<span class="w"> </span>at<span class="w"> </span>0xfb5f0000<span class="w"> </span><span class="nv">bufsz</span><span class="o">=</span>0x1000<span class="w"> </span><span class="nv">memsz</span><span class="o">=</span>0x1000
<span class="o">[</span><span class="w"> </span><span class="m">8103</span>.743956<span class="o">]</span><span class="w"> </span>RNG<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>initialised:<span class="w"> </span>omitting<span class="w"> </span><span class="s2">&quot;kaslr-seed&quot;</span><span class="w"> </span>property
<span class="o">[</span><span class="w"> </span><span class="m">8103</span>.744036<span class="o">]</span><span class="w"> </span>RNG<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>initialised:<span class="w"> </span>omitting<span class="w"> </span><span class="s2">&quot;rng-seed&quot;</span><span class="w"> </span>property
<span class="o">[</span><span class="w"> </span><span class="m">8103</span>.745069<span class="o">]</span><span class="w"> </span>Loaded<span class="w"> </span>dtb<span class="w"> </span>at<span class="w"> </span>0xfb400000<span class="w"> </span><span class="nv">bufsz</span><span class="o">=</span>0x2eec<span class="w"> </span><span class="nv">memsz</span><span class="o">=</span>0x3000
<span class="o">[</span><span class="w"> </span><span class="m">8103</span>.745166<span class="o">]</span><span class="w"> </span>Loaded<span class="w"> </span>kernel<span class="w"> </span>at<span class="w"> </span>0xdb600000<span class="w"> </span><span class="nv">bufsz</span><span class="o">=</span>0x29b2200<span class="w"> </span><span class="nv">memsz</span><span class="o">=</span>0x2a60000
<span class="o">[</span><span class="w"> </span><span class="m">8103</span>.745291<span class="o">]</span><span class="w"> </span><span class="nv">nr_segments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span>
<span class="o">[</span><span class="w"> </span><span class="m">8103</span>.745354<span class="o">]</span><span class="w"> </span>segment<span class="o">[</span><span class="m">0</span><span class="o">]</span>:<span class="w"> </span><span class="nv">buf</span><span class="o">=</span>0x<span class="o">(</span>____ptrval____<span class="o">)</span><span class="w"> </span><span class="nv">bufsz</span><span class="o">=</span>0x29b2200<span class="w"> </span><span class="nv">mem</span><span class="o">=</span>0xdb600000<span class="w"> </span><span class="nv">memsz</span><span class="o">=</span>0x2a60000
<span class="o">[</span><span class="w"> </span><span class="m">8103</span>.820075<span class="o">]</span><span class="w"> </span>segment<span class="o">[</span><span class="m">1</span><span class="o">]</span>:<span class="w"> </span><span class="nv">buf</span><span class="o">=</span>0x<span class="o">(</span>____ptrval____<span class="o">)</span><span class="w"> </span><span class="nv">bufsz</span><span class="o">=</span>0x1000<span class="w"> </span><span class="nv">mem</span><span class="o">=</span>0xfb5f0000<span class="w"> </span><span class="nv">memsz</span><span class="o">=</span>0x1000
<span class="o">[</span><span class="w"> </span><span class="m">8103</span>.820205<span class="o">]</span><span class="w"> </span>segment<span class="o">[</span><span class="m">2</span><span class="o">]</span>:<span class="w"> </span><span class="nv">buf</span><span class="o">=</span>0x<span class="o">(</span>____ptrval____<span class="o">)</span><span class="w"> </span><span class="nv">bufsz</span><span class="o">=</span>0x2eec<span class="w"> </span><span class="nv">mem</span><span class="o">=</span>0xfb400000<span class="w"> </span><span class="nv">memsz</span><span class="o">=</span>0x3000
<span class="o">[</span><span class="w"> </span><span class="m">8103</span>.848444<span class="o">]</span><span class="w"> </span>machine_kexec_post_load:119:
<span class="o">[</span><span class="w"> </span><span class="m">8103</span>.848521<span class="o">]</span><span class="w">   </span>kexec<span class="w"> </span>kimage<span class="w"> </span>info:
<span class="o">[</span><span class="w"> </span><span class="m">8103</span>.848581<span class="o">]</span><span class="w">     </span>type:<span class="w">        </span><span class="m">1</span>
<span class="o">[</span><span class="w"> </span><span class="m">8103</span>.848646<span class="o">]</span><span class="w">     </span>head:<span class="w">        </span><span class="m">4</span>
<span class="o">[</span><span class="w"> </span><span class="m">8103</span>.848708<span class="o">]</span><span class="w">     </span>kern_reloc:<span class="w"> </span>0x0000000000000000
<span class="o">[</span><span class="w"> </span><span class="m">8103</span>.848785<span class="o">]</span><span class="w">     </span>el2_vectors:<span class="w"> </span>0x0000000000000000
<span class="o">[</span><span class="w"> </span><span class="m">8103</span>.848860<span class="o">]</span><span class="w"> </span>kexec_file_load:<span class="w"> </span>type:1,<span class="w"> </span>start:0xdb600000<span class="w"> </span>head:0x4<span class="w"> </span>flags:0xe
</pre></div>
<p>因为这里使用--reuse-cmdline的缘故，dtb和rootfs都使用正常系统之前的给的，但是这个命令会把device tree里面的memory node给修改成crashkernel 传进来的那部分，并且boot command 的crashkernel选项会被删除掉。</p>
<p>这些修改也比较好理解，如果还是用之前的device tree，那就肯定会覆盖掉之前系统运行的痕迹。 如果boot command里面还有crashkernel，那系统在预留这部分内存，系统就没有地方可以运行了。</p>
<p>当然这里也可以根据自己的情况适当调整device tree ，rootfs 和boot command。</p>
</div>
<div class="section" id="crash">
<h2>触发系统crash</h2>
<p>这里可以自己写一个模块来模拟触发kernel crash，为了简单，这里使用如下命令出发crash：</p>
<div class="highlight"><pre><span></span><span class="nb">echo</span><span class="w"> </span>c<span class="w"> </span>&gt;<span class="w"> </span>/proc/sysrq-trigger
</pre></div>
<p>执行结果如下：</p>
<div class="highlight"><pre><span></span><span class="c1"># echo c &gt; /proc/sysrq-trigger</span>
<span class="o">[</span><span class="m">38426</span>.348804<span class="o">]</span><span class="w"> </span>sysrq:<span class="w"> </span>Trigger<span class="w"> </span>a<span class="w"> </span>crash
<span class="o">[</span><span class="m">38426</span>.348871<span class="o">]</span><span class="w"> </span>Kernel<span class="w"> </span>panic<span class="w"> </span>-<span class="w"> </span>not<span class="w"> </span>syncing:<span class="w"> </span>sysrq<span class="w"> </span>triggered<span class="w"> </span>crash
<span class="o">[</span><span class="m">38426</span>.348947<span class="o">]</span><span class="w"> </span>CPU:<span class="w"> </span><span class="m">0</span><span class="w"> </span>PID:<span class="w"> </span><span class="m">147</span><span class="w"> </span>Comm:<span class="w"> </span>sh<span class="w"> </span>Kdump:<span class="w"> </span>loaded<span class="w"> </span>Not<span class="w"> </span>tainted<span class="w"> </span><span class="m">6</span>.8.0<span class="w"> </span><span class="c1">#2</span>
<span class="o">[</span><span class="m">38426</span>.349070<span class="o">]</span><span class="w"> </span>Hardware<span class="w"> </span>name:<span class="w"> </span>FVP<span class="w"> </span>Base<span class="w"> </span>RevC<span class="w"> </span><span class="o">(</span>DT<span class="o">)</span>
<span class="o">[</span><span class="m">38426</span>.349143<span class="o">]</span><span class="w"> </span>Call<span class="w"> </span>trace:
<span class="o">[</span><span class="m">38426</span>.349198<span class="o">]</span><span class="w">  </span>dump_backtrace+0x90/0xe8
<span class="o">[</span><span class="m">38426</span>.349340<span class="o">]</span><span class="w">  </span>show_stack+0x18/0x24
<span class="o">[</span><span class="m">38426</span>.349479<span class="o">]</span><span class="w">  </span>dump_stack_lvl+0x48/0x60
<span class="o">[</span><span class="m">38426</span>.349623<span class="o">]</span><span class="w">  </span>dump_stack+0x18/0x24
<span class="o">[</span><span class="m">38426</span>.349763<span class="o">]</span><span class="w">  </span>panic+0x380/0x3b4
<span class="o">[</span><span class="m">38426</span>.349884<span class="o">]</span><span class="w">  </span>sysrq_reset_seq_param_set+0x0/0x98
<span class="o">[</span><span class="m">38426</span>.350024<span class="o">]</span><span class="w">  </span>__handle_sysrq+0xe4/0x1cc
<span class="o">[</span><span class="m">38426</span>.350158<span class="o">]</span><span class="w">  </span>write_sysrq_trigger+0xdc/0xf0
<span class="o">[</span><span class="m">38426</span>.350298<span class="o">]</span><span class="w">  </span>proc_reg_write+0x9c/0xf0
<span class="o">[</span><span class="m">38426</span>.350417<span class="o">]</span><span class="w">  </span>vfs_write+0xd4/0x360
<span class="o">[</span><span class="m">38426</span>.350555<span class="o">]</span><span class="w">  </span>ksys_write+0x74/0x10c
<span class="o">[</span><span class="m">38426</span>.350695<span class="o">]</span><span class="w">  </span>__arm64_sys_write+0x1c/0x28
<span class="o">[</span><span class="m">38426</span>.350840<span class="o">]</span><span class="w">  </span>invoke_syscall+0x48/0x110
<span class="o">[</span><span class="m">38426</span>.350976<span class="o">]</span><span class="w">  </span>el0_svc_common.constprop.0+0x40/0xe0
<span class="o">[</span><span class="m">38426</span>.351121<span class="o">]</span><span class="w">  </span>do_el0_svc+0x1c/0x28
<span class="o">[</span><span class="m">38426</span>.351253<span class="o">]</span><span class="w">  </span>el0_svc+0x34/0xb4
<span class="o">[</span><span class="m">38426</span>.351353<span class="o">]</span><span class="w">  </span>el0t_64_sync_handler+0x120/0x12c
<span class="o">[</span><span class="m">38426</span>.351468<span class="o">]</span><span class="w">  </span>el0t_64_sync+0x190/0x194
<span class="o">[</span><span class="m">38426</span>.351572<span class="o">]</span><span class="w"> </span>SMP:<span class="w"> </span>stopping<span class="w"> </span>secondary<span class="w"> </span>CPUs
<span class="o">[</span><span class="m">38426</span>.351647<span class="o">]</span><span class="w"> </span>Kernel<span class="w"> </span>Offset:<span class="w"> </span>disabled
<span class="o">[</span><span class="m">38426</span>.351706<span class="o">]</span><span class="w"> </span>CPU<span class="w"> </span>features:<span class="w"> </span>0x0,00000000,0062cd4a,3346773f
<span class="o">[</span><span class="m">38426</span>.351790<span class="o">]</span><span class="w"> </span>Memory<span class="w"> </span>Limit:<span class="w"> </span>none
<span class="o">[</span><span class="m">38426</span>.352166<span class="o">]</span><span class="w"> </span>Starting<span class="w"> </span>crashdump<span class="w"> </span>kernel...
<span class="o">[</span><span class="m">38426</span>.352229<span class="o">]</span><span class="w"> </span>Bye!
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Booting<span class="w"> </span>Linux<span class="w"> </span>on<span class="w"> </span>physical<span class="w"> </span>CPU<span class="w"> </span>0x0000000000<span class="w"> </span><span class="o">[</span>0x410fd0f0<span class="o">]</span>
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Linux<span class="w"> </span>version<span class="w"> </span><span class="m">6</span>.8.0<span class="w"> </span><span class="o">(</span>qixxu01@a015921<span class="o">)</span><span class="w"> </span><span class="o">(</span>aarch64-none-linux-gnu-gcc<span class="w"> </span><span class="o">(</span>Arm<span class="w"> </span>GNU<span class="w"> </span>Toolchain<span class="w"> </span><span class="m">13</span>.2.rel1<span class="w"> </span><span class="o">(</span>Build<span class="w"> </span>arm-13.7<span class="o">))</span><span class="w"> </span><span class="m">13</span>.2.1<span class="w"> </span><span class="m">20231009</span>,<span class="w"> </span>GNU<span class="w"> </span>ld<span class="w"> </span><span class="o">(</span>Arm<span class="w"> </span>GNU<span class="w"> </span>Toolchain<span class="w"> </span><span class="m">13</span>.2.rel1<span class="w"> </span><span class="o">(</span>Build<span class="w"> </span>arm-13.7<span class="o">))</span><span class="w"> </span><span class="m">2</span>.41.0.20231009<span class="o">)</span><span class="w"> </span><span class="c1">#1 SMP PREEMPT Wed Jul 31 17:32:39 CST 2024</span>
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>KASLR<span class="w"> </span>disabled<span class="w"> </span>due<span class="w"> </span>to<span class="w"> </span>lack<span class="w"> </span>of<span class="w"> </span>seed
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Machine<span class="w"> </span>model:<span class="w"> </span>FVP<span class="w"> </span>Base<span class="w"> </span>RevC
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>earlycon:<span class="w"> </span>pl11<span class="w"> </span>at<span class="w"> </span>MMIO<span class="w"> </span>0x000000001c090000<span class="w"> </span><span class="o">(</span>options<span class="w"> </span><span class="s1">&#39;&#39;</span><span class="o">)</span>
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>printk:<span class="w"> </span>legacy<span class="w"> </span>bootconsole<span class="w"> </span><span class="o">[</span>pl11<span class="o">]</span><span class="w"> </span>enabled
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>efi:<span class="w"> </span>UEFI<span class="w"> </span>not<span class="w"> </span>found.
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>OF:<span class="w"> </span>fdt:<span class="w"> </span>Reserving<span class="w"> </span><span class="m">4</span><span class="w"> </span>KiB<span class="w"> </span>of<span class="w"> </span>memory<span class="w"> </span>at<span class="w"> </span>0xfb5f0000<span class="w"> </span><span class="k">for</span><span class="w"> </span>elfcorehdr
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Reserved<span class="w"> </span>memory:<span class="w"> </span>created<span class="w"> </span>DMA<span class="w"> </span>memory<span class="w"> </span>pool<span class="w"> </span>at<span class="w"> </span>0x0000000018000000,<span class="w"> </span>size<span class="w"> </span><span class="m">8</span><span class="w"> </span>MiB
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>OF:<span class="w"> </span>reserved<span class="w"> </span>mem:<span class="w"> </span>initialized<span class="w"> </span>node<span class="w"> </span>vram@18000000,<span class="w"> </span>compatible<span class="w"> </span>id<span class="w"> </span>shared-dma-pool
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>OF:<span class="w"> </span>reserved<span class="w"> </span>mem:<span class="w"> </span>0x0000000018000000..0x00000000187fffff<span class="w"> </span><span class="o">(</span><span class="m">8192</span><span class="w"> </span>KiB<span class="o">)</span><span class="w"> </span>nomap<span class="w"> </span>non-reusable<span class="w"> </span>vram@18000000
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>NUMA:<span class="w"> </span>No<span class="w"> </span>NUMA<span class="w"> </span>configuration<span class="w"> </span>found
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>NUMA:<span class="w"> </span>Faking<span class="w"> </span>a<span class="w"> </span>node<span class="w"> </span>at<span class="w"> </span><span class="o">[</span>mem<span class="w"> </span>0x00000000db600000-0x00000000fb5fffff<span class="o">]</span>
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>NUMA:<span class="w"> </span>NODE_DATA<span class="w"> </span><span class="o">[</span>mem<span class="w"> </span>0xfb4ec9c0-0xfb4eefff<span class="o">]</span>
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Zone<span class="w"> </span>ranges:
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w">   </span>DMA<span class="w">      </span><span class="o">[</span>mem<span class="w"> </span>0x00000000db600000-0x00000000fb5fffff<span class="o">]</span>
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w">   </span>DMA32<span class="w">    </span>empty
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w">   </span>Normal<span class="w">   </span>empty
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Movable<span class="w"> </span>zone<span class="w"> </span>start<span class="w"> </span><span class="k">for</span><span class="w"> </span>each<span class="w"> </span>node
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Early<span class="w"> </span>memory<span class="w"> </span>node<span class="w"> </span>ranges
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w">   </span>node<span class="w">   </span><span class="m">0</span>:<span class="w"> </span><span class="o">[</span>mem<span class="w"> </span>0x00000000db600000-0x00000000fb5fffff<span class="o">]</span>
</pre></div>
<p>这里可以看到在Bye 之后马上就运行那个Dump-capture系统，运行的物理地址可以看到也就是之前crashkernel预留的那部分地址。 运行成功之后，可以看到在/proc下面会多出 /proc/vmcore文件。</p>
<p>这个文件就是我们需要的core dump文件。</p>
<p>这个文件是如何生成的呢，在前面使用kexec 加载Dump-capture kernel的时候，就提前把正常kernel运行相关的信息记录在crash kernel 预留的一块内存里， 参考：</p>
<div class="highlight"><pre><span></span><span class="cp">#0 crash_prepare_elf64_headers(mem = (struct crash_mem*) 0xFFFF0008002F9240, need_kernel_map = 1, addr = (void**) 0xFFFF8000834D3C18, sz = (long unsigned int*) 0xFFFF8000834D3C20) at crash_core.c:477</span>
<span class="cp">#1 prepare_elf_headers(addr = (void**) 0xFFFF8000834D3C18, sz = (long unsigned int*) 0xFFFF8000834D3C20) at machine_kexec_file.c:77</span>
<span class="cp">#2 image_load(image = (struct kimage*) 0xFFFF00080001AC00, kernel</span>
<span class="p">,</span><span class="w"> </span><span class="n">kernel_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">43721216</span><span class="p">,</span><span class="w"> </span><span class="n">initrd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="mh">0x0</span><span class="p">,</span><span class="w"> </span><span class="n">initrd_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">cmdline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xFFFF0008002F8C00</span><span class="w"> </span><span class="s">&quot;console=ttyAMA0 earlycon=pl011,0x1c090000 root=/dev/vda1 rw ip=dhcp debug loglevel=9 crash_kexec_post_notifiers=1  maxcpus=1 reset&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cmdline_len</span>
<span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">kexec_image</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">103</span>
<span class="cp">#3 PTR_ERR(ptr = &lt;Value currently has no location&gt;) at kexec_file.c:73</span>
<span class="cp">#4 kimage_file_prepare_segments(image = (struct kimage*) 0xFFFF00080001AC00, kernel_fd = &lt;Value currently has no location&gt;, initrd_fd = &lt;Value optimised away by compiler&gt;, cmdline_ptr = &lt;Value optimised away by compiler&gt;, cmdline_len = 139, flags = 6) at kexec_file.c:259</span>
<span class="cp">#5 kimage_file_alloc_init(rimage</span>
<span class="p">,</span><span class="w"> </span><span class="n">kernel_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="n">currently</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">location</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">initrd_fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="n">currently</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">location</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">cmdline_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="n">currently</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="n">location</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">cmdline_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">139</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">kexec_file</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">307</span>
<span class="cp">#6 __do_sys_kexec_file_load(kernel_fd = 43721216, initrd_fd = &lt;Value optimised away by compiler&gt;, cmdline_len = 139, cmdline_ptr = &lt;Value optimised away by compiler&gt;, flags = 6) at kexec_file.c:308</span>
<span class="cp">#7 __arm64_sys_kexec_file_load(regs ERROR(CMD367-IMG96):</span>
</pre></div>
<p>在Dump-capture kernel boot阶段在把这段内存信息给映射成/proc文件，参考函数： vmcore_init</p>
</div>
<div class="section" id="vmcorehost">
<h2>复制vmcore到host</h2>
<p>最简单把vmcore 文件copy的方式,可以使用如下命令：</p>
<div class="highlight"><pre><span></span>cp<span class="w"> </span>/proc/vmcore<span class="w"> </span>/root/vmcore
</pre></div>
<p>然后再在Host里面使用如下命令把rootfs里面的的vmcore给复制到 host磁盘：</p>
<div class="highlight"><pre><span></span>sudo<span class="w"> </span>losetup<span class="w"> </span>-f<span class="w"> </span>-P<span class="w"> </span>rootfs/grub-busybox.img
sudo<span class="w"> </span>mount<span class="w"> </span>/dev/loop17p1<span class="w"> </span>tmp

sudo<span class="w">  </span>cp<span class="w"> </span>tmp/root/vmcore<span class="w"> </span>.
<span class="c1"># 完成后卸载和清理</span>
sudo<span class="w"> </span>umount<span class="w"> </span>tmp
sudo<span class="w"> </span>losetup<span class="w"> </span>-d<span class="w"> </span>/dev/loop17
</pre></div>
<p>这里有个非常大的缺点就是vmcore文件非常大(G级别)，可能不是所有的目标板都有那么大的空间，这个时候就可以使用makedumpfile了。 这里可以使用：</p>
<div class="highlight"><pre><span></span>makedumpfile<span class="w"> </span>-c<span class="w"> </span>-d<span class="w"> </span><span class="m">30</span><span class="w"> </span>/proc/vmcore<span class="w"> </span>/root/vmcore
</pre></div>
<p>这个vmcore 大概可以压缩到M级别。 有了vmcore文件接下来就可以使用crash-utility来分析这个crash了。</p>
</div>
<div class="section" id="crash-utility-1">
<h2>crash-utility编译和使用</h2>
<p>因为target是arm64，所以不能使用Host系统自带的crash-utility.  编译命令：</p>
<div class="highlight"><pre><span></span>wget<span class="w"> </span>https://github.com/crash-utility/crash/archive/refs/tags/8.0.5.tar.gz
tar<span class="w"> </span>-zxvf<span class="w"> </span><span class="m">8</span>.0.5.tar.gz
<span class="nb">cd</span><span class="w"> </span>crash-8.0.5/
make<span class="w"> </span><span class="nv">target</span><span class="o">=</span>ARM64
</pre></div>
<p>接下来就可以使用crash命令来分析vmcore：</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>src/crash-8.0.5/crash<span class="w">  </span>src/linux/vmlinux<span class="w"> </span>vmcore

For<span class="w"> </span>help,<span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="s2">&quot;help&quot;</span>.
Type<span class="w"> </span><span class="s2">&quot;apropos word&quot;</span><span class="w"> </span>to<span class="w"> </span>search<span class="w"> </span><span class="k">for</span><span class="w"> </span>commands<span class="w"> </span>related<span class="w"> </span>to<span class="w"> </span><span class="s2">&quot;word&quot;</span>...

please<span class="w"> </span>wait...<span class="w"> </span><span class="o">(</span>determining<span class="w"> </span>panic<span class="w"> </span>task<span class="o">)</span>
WARNING:<span class="w"> </span>cannot<span class="w"> </span>determine<span class="w"> </span>starting<span class="w"> </span>stack<span class="w"> </span>frame<span class="w"> </span><span class="k">for</span><span class="w"> </span>task<span class="w"> </span>ffff800082533f00

WARNING:<span class="w"> </span>cannot<span class="w"> </span>determine<span class="w"> </span>starting<span class="w"> </span>stack<span class="w"> </span>frame<span class="w"> </span><span class="k">for</span><span class="w"> </span>task<span class="w"> </span>ffff00080033b300

WARNING:<span class="w"> </span>cannot<span class="w"> </span>determine<span class="w"> </span>starting<span class="w"> </span>stack<span class="w"> </span>frame<span class="w"> </span><span class="k">for</span><span class="w"> </span>task<span class="w"> </span>ffff00080033c400

WARNING:<span class="w"> </span>cannot<span class="w"> </span>determine<span class="w"> </span>starting<span class="w"> </span>stack<span class="w"> </span>frame<span class="w"> </span><span class="k">for</span><span class="w"> </span>task<span class="w"> </span>ffff00080033d500

WARNING:<span class="w"> </span>cannot<span class="w"> </span>determine<span class="w"> </span>starting<span class="w"> </span>stack<span class="w"> </span>frame<span class="w"> </span><span class="k">for</span><span class="w"> </span>task<span class="w"> </span>ffff00080033e600

WARNING:<span class="w"> </span>cannot<span class="w"> </span>determine<span class="w"> </span>starting<span class="w"> </span>stack<span class="w"> </span>frame<span class="w"> </span><span class="k">for</span><span class="w"> </span>task<span class="w"> </span>ffff000800348000

WARNING:<span class="w"> </span>cannot<span class="w"> </span>determine<span class="w"> </span>starting<span class="w"> </span>stack<span class="w"> </span>frame<span class="w"> </span><span class="k">for</span><span class="w"> </span>task<span class="w"> </span>ffff00080034a200

WARNING:<span class="w"> </span>cannot<span class="w"> </span>determine<span class="w"> </span>starting<span class="w"> </span>stack<span class="w"> </span>frame<span class="w"> </span><span class="k">for</span><span class="w"> </span>task<span class="w"> </span>ffff000801c3e600
<span class="w">      </span>KERNEL:<span class="w"> </span>src/linux/vmlinux
<span class="w">    </span>DUMPFILE:<span class="w"> </span>vmcore
<span class="w">        </span>CPUS:<span class="w"> </span><span class="m">8</span>
<span class="w">        </span>DATE:<span class="w"> </span>Thu<span class="w"> </span>Aug<span class="w">  </span><span class="m">1</span><span class="w"> </span><span class="m">09</span>:24:51<span class="w"> </span>CST<span class="w"> </span><span class="m">2024</span>
<span class="w">      </span>UPTIME:<span class="w"> </span><span class="m">00</span>:04:56
LOAD<span class="w"> </span>AVERAGE:<span class="w"> </span><span class="m">0</span>.01,<span class="w"> </span><span class="m">0</span>.02,<span class="w"> </span><span class="m">0</span>.00
<span class="w">       </span>TASKS:<span class="w"> </span><span class="m">113</span>
<span class="w">    </span>NODENAME:<span class="w"> </span>ArmBaseFVP
<span class="w">     </span>RELEASE:<span class="w"> </span><span class="m">6</span>.8.0
<span class="w">     </span>VERSION:<span class="w"> </span><span class="c1">#2 SMP PREEMPT Wed Jul 31 17:54:17 CST 2024</span>
<span class="w">     </span>MACHINE:<span class="w"> </span>aarch64<span class="w">  </span><span class="o">(</span>unknown<span class="w"> </span>Mhz<span class="o">)</span>
<span class="w">      </span>MEMORY:<span class="w"> </span><span class="m">4</span><span class="w"> </span>GB
<span class="w">       </span>PANIC:<span class="w"> </span><span class="s2">&quot;Kernel panic - not syncing: sysrq triggered crash&quot;</span>
<span class="w">         </span>PID:<span class="w"> </span><span class="m">145</span>
<span class="w">     </span>COMMAND:<span class="w"> </span><span class="s2">&quot;sh&quot;</span>
<span class="w">        </span>TASK:<span class="w"> </span>ffff000801c3e600<span class="w">  </span><span class="o">[</span>THREAD_INFO:<span class="w"> </span>ffff000801c3e600<span class="o">]</span>
<span class="w">         </span>CPU:<span class="w"> </span><span class="m">6</span>
<span class="w">       </span>STATE:<span class="w"> </span>TASK_RUNNING<span class="w"> </span><span class="o">(</span>PANIC<span class="o">)</span>
crash&gt;<span class="w"> </span>bt
PID:<span class="w"> </span><span class="m">145</span><span class="w">      </span>TASK:<span class="w"> </span>ffff000801c3e600<span class="w">  </span>CPU:<span class="w"> </span><span class="m">6</span><span class="w">    </span>COMMAND:<span class="w"> </span><span class="s2">&quot;sh&quot;</span>
<span class="w"> </span><span class="c1">#0 [ffff80008347bb40] __crash_kexec at ffff80008014f0bc</span>
<span class="w"> </span><span class="c1">#1 [ffff80008347bbc0] panic at ffff80008008dbf8</span>
<span class="w"> </span><span class="c1">#2 [ffff80008347bc50] sysrq_handle_crash at ffff80008082f548</span>
<span class="w"> </span><span class="c1">#3 [ffff80008347bc60] __handle_sysrq at ffff80008082fc50</span>
<span class="w"> </span><span class="c1">#4 [ffff80008347bcb0] write_sysrq_trigger at ffff8000808303d8</span>
<span class="w"> </span><span class="c1">#5 [ffff80008347bd00] proc_reg_write at ffff80008035737c</span>
<span class="w"> </span><span class="c1">#6 [ffff80008347bd80] vfs_write at ffff8000802cebc4</span>
<span class="w"> </span><span class="c1">#7 [ffff80008347bdd0] ksys_write at ffff8000802ceff8</span>
<span class="w"> </span><span class="c1">#8 [ffff80008347be00] __arm64_sys_write at ffff8000802cf0ac</span>
<span class="w"> </span><span class="c1">#9 [ffff80008347be10] invoke_syscall at ffff800080026abc</span>
<span class="c1">#10 [ffff80008347be40] el0_svc_common.constprop.0 at ffff800080026bc4</span>
<span class="c1">#11 [ffff80008347be70] do_el0_svc at ffff800080026c80</span>
<span class="c1">#12 [ffff80008347be80] el0_svc at ffff800081050fd8</span>
<span class="c1">#13 [ffff80008347bea0] el0t_64_sync_handler at ffff800081051408</span>
<span class="c1">#14 [ffff80008347bfe0] el0t_64_sync at ffff800080011d48</span>
<span class="w">     </span>PC:<span class="w"> </span>0000ffffa896e128<span class="w">   </span>LR:<span class="w"> </span>0000aaaae35485f0<span class="w">   </span>SP:<span class="w"> </span>0000fffff8909b50
<span class="w">    </span>X29:<span class="w"> </span>0000fffff8909b50<span class="w">  </span>X28:<span class="w"> </span><span class="m">0000000000000000</span><span class="w">  </span>X27:<span class="w"> </span><span class="m">0000000000000000</span>
<span class="w">    </span>X26:<span class="w"> </span>0000aaab22fed6e0<span class="w">  </span>X25:<span class="w"> </span><span class="m">0000000000000020</span><span class="w">  </span>X24:<span class="w"> </span>0000fffff8909be0
<span class="w">    </span>X23:<span class="w"> </span>0000aaab22ff1a30<span class="w">  </span>X22:<span class="w"> </span>0000aaaae3602000<span class="w">  </span>X21:<span class="w"> </span><span class="m">0000000000000002</span>
<span class="w">    </span>X20:<span class="w"> </span>0000aaab22ff1a30<span class="w">  </span>X19:<span class="w"> </span><span class="m">0000000000000001</span><span class="w">  </span>X18:<span class="w"> </span><span class="m">0000000000000004</span>
<span class="w">    </span>X17:<span class="w"> </span>0000ffffa896e100<span class="w">  </span>X16:<span class="w"> </span>0000aaaae3601988<span class="w">  </span>X15:<span class="w"> </span><span class="m">0000000000000001</span>
<span class="w">    </span>X14:<span class="w"> </span><span class="m">0000000000000001</span><span class="w">  </span>X13:<span class="w"> </span>0000aaab22fed6cb<span class="w">  </span>X12:<span class="w"> </span>0000aaaae35fc0b4
<span class="w">    </span>X11:<span class="w"> </span>0000aaaae35e246f<span class="w">  </span>X10:<span class="w"> </span><span class="m">0000000000000000</span><span class="w">   </span>X9:<span class="w"> </span><span class="m">0000000000000040</span>
<span class="w">     </span>X8:<span class="w"> </span><span class="m">0000000000000040</span><span class="w">   </span>X7:<span class="w"> </span>0000000000000ef1<span class="w">   </span>X6:<span class="w"> </span><span class="m">0000000000000063</span>
<span class="w">     </span>X5:<span class="w"> </span>fffffffffffffffe<span class="w">   </span>X4:<span class="w"> </span><span class="m">0000000000000001</span><span class="w">   </span>X3:<span class="w"> </span><span class="m">0000000000000001</span>
<span class="w">     </span>X2:<span class="w"> </span><span class="m">0000000000000002</span><span class="w">   </span>X1:<span class="w"> </span>0000aaab22ff1a30<span class="w">   </span>X0:<span class="w"> </span><span class="m">0000000000000001</span>
<span class="w">    </span>ORIG_X0:<span class="w"> </span><span class="m">0000000000000001</span><span class="w">  </span>SYSCALLNO:<span class="w"> </span><span class="m">40</span><span class="w">  </span>PSTATE:<span class="w"> </span><span class="m">80000000</span>

crash&gt;<span class="w"> </span>log
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Booting<span class="w"> </span>Linux<span class="w"> </span>on<span class="w"> </span>physical<span class="w"> </span>CPU<span class="w"> </span>0x0000000000<span class="w"> </span><span class="o">[</span>0x410fd0f0<span class="o">]</span>
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Linux<span class="w"> </span>version<span class="w"> </span><span class="m">6</span>.8.0<span class="w"> </span><span class="o">(</span>qixxu01@a015921<span class="o">)</span><span class="w"> </span><span class="o">(</span>aarch64-none-linux-gnu-gcc<span class="w"> </span><span class="o">(</span>Arm<span class="w"> </span>GNU<span class="w"> </span>Toolchain<span class="w"> </span><span class="m">13</span>.2.rel1<span class="w"> </span><span class="o">(</span>Build<span class="w"> </span>arm-13.7<span class="o">))</span><span class="w"> </span><span class="m">13</span>.2.1<span class="w"> </span><span class="m">20231009</span>,<span class="w"> </span>GNU<span class="w"> </span>ld<span class="w"> </span><span class="o">(</span>Arm<span class="w"> </span>GNU<span class="w"> </span>Toolchain<span class="w"> </span><span class="m">13</span>.2.rel1<span class="w"> </span><span class="o">(</span>Build<span class="w"> </span>arm-13.7<span class="o">))</span><span class="w"> </span><span class="m">2</span>.41.0.20231009<span class="o">)</span><span class="w"> </span><span class="c1">#2 SMP PREEMPT Wed Jul 31 17:54:17 CST 2024</span>
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>KASLR<span class="w"> </span>disabled<span class="w"> </span>due<span class="w"> </span>to<span class="w"> </span>lack<span class="w"> </span>of<span class="w"> </span>seed
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Machine<span class="w"> </span>model:<span class="w"> </span>FVP<span class="w"> </span>Base<span class="w"> </span>RevC
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>earlycon:<span class="w"> </span>pl11<span class="w"> </span>at<span class="w"> </span>MMIO<span class="w"> </span>0x000000001c090000<span class="w"> </span><span class="o">(</span>options<span class="w"> </span><span class="s1">&#39;&#39;</span><span class="o">)</span>
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>printk:<span class="w"> </span>legacy<span class="w"> </span>bootconsole<span class="w"> </span><span class="o">[</span>pl11<span class="o">]</span><span class="w"> </span>enabled
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>efi:<span class="w"> </span>UEFI<span class="w"> </span>not<span class="w"> </span>found.
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Reserved<span class="w"> </span>memory:<span class="w"> </span>created<span class="w"> </span>DMA<span class="w"> </span>memory<span class="w"> </span>pool<span class="w"> </span>at<span class="w"> </span>0x0000000018000000,<span class="w"> </span>size<span class="w"> </span><span class="m">8</span><span class="w"> </span>MiB
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>OF:<span class="w"> </span>reserved<span class="w"> </span>mem:<span class="w"> </span>initialized<span class="w"> </span>node<span class="w"> </span>vram@18000000,<span class="w"> </span>compatible<span class="w"> </span>id<span class="w"> </span>shared-dma-pool
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>OF:<span class="w"> </span>reserved<span class="w"> </span>mem:<span class="w"> </span>0x0000000018000000..0x00000000187fffff<span class="w"> </span><span class="o">(</span><span class="m">8192</span><span class="w"> </span>KiB<span class="o">)</span><span class="w"> </span>nomap<span class="w"> </span>non-reusable<span class="w"> </span>vram@18000000
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>NUMA:<span class="w"> </span>No<span class="w"> </span>NUMA<span class="w"> </span>configuration<span class="w"> </span>found
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>NUMA:<span class="w"> </span>Faking<span class="w"> </span>a<span class="w"> </span>node<span class="w"> </span>at<span class="w"> </span><span class="o">[</span>mem<span class="w"> </span>0x0000000080000000-0x00000008ffffffff<span class="o">]</span>
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>NUMA:<span class="w"> </span>NODE_DATA<span class="w"> </span><span class="o">[</span>mem<span class="w"> </span>0x8ff7f29c0-0x8ff7f4fff<span class="o">]</span>
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Zone<span class="w"> </span>ranges:
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w">   </span>DMA<span class="w">      </span><span class="o">[</span>mem<span class="w"> </span>0x0000000080000000-0x00000000ffffffff<span class="o">]</span>
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w">   </span>DMA32<span class="w">    </span>empty
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w">   </span>Normal<span class="w">   </span><span class="o">[</span>mem<span class="w"> </span>0x0000000100000000-0x00000008ffffffff<span class="o">]</span>
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Movable<span class="w"> </span>zone<span class="w"> </span>start<span class="w"> </span><span class="k">for</span><span class="w"> </span>each<span class="w"> </span>node
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Early<span class="w"> </span>memory<span class="w"> </span>node<span class="w"> </span>ranges
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w">   </span>node<span class="w">   </span><span class="m">0</span>:<span class="w"> </span><span class="o">[</span>mem<span class="w"> </span>0x0000000080000000-0x00000000feffffff<span class="o">]</span>
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w">   </span>node<span class="w">   </span><span class="m">0</span>:<span class="w"> </span><span class="o">[</span>mem<span class="w"> </span>0x0000000880000000-0x00000008ffffffff<span class="o">]</span>
<span class="o">[</span><span class="w">    </span><span class="m">0</span>.000000<span class="o">]</span><span class="w"> </span>Initmem<span class="w"> </span>setup<span class="w"> </span>node<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">[</span>mem<span class="w"> </span>0x0000000080000000-0x00000008ffffffff<span class="o">]</span>
</pre></div>
<p>crash-utility 技巧还是有很多的，可以参考 <a class="reference external" href="https://crash-utility.github.io/crash_whitepaper.html">crash whitepaper</a></p>
<p>参考：</p>
<ol class="arabic simple">
<li><a class="reference external" href="https://community.ibm.com/community/user/power/blogs/sachin-bappalige/2024/05/16/kdump-and-fadump-linux-features">Linux kernel crash-dump mechanism</a></li>
<li><a class="reference external" href="https://opensource.com/article/17/6/kdump-usage-and-internals">Using Kdump for examining Linux Kernel crashes</a></li>
</ol>
</div>
<p><a href="https://geesun.github.io/posts/2024/08/04_kdump_crash_kernel.html#disqus_thread">comments</a></p>                </article>
            </aside><!-- /#featured -->
                <section id="content" class="body">
                    <h1>Other articles</h1>
                    <ol id="posts-list" class="hfeed">

            <li><article class="hentry">
                <header>
                    <h1><a href="../posts/2024/07/03_debug_kernel_module.html" rel="bookmark"
                           title="Permalink to 如何使用ArmDS调试动态加载的Linux kernel模块">如何使用ArmDS调试动态加载的Linux kernel模块</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <span>二 23 七月 2024</span>
<span>| tags: <a href="../tag/linux.html">Linux</a><a href="../tag/debug.html">Debug</a></span>
</footer><!-- /.post-info -->                <p>根据Arm Development Studio User Guide的 <a class="reference external" href="https://developer.arm.com/documentation/101470/2024-0/Debugging-Embedded-Systems/About-OS-awareness/About-debugging-Linux-kernel-modules">About debugging Linux kernel modules</a> ,ArmDS是可以调试动态加载的Linux kernel 模块。 但是需要ArmDS支持你所使用的kernel版本，ArmDS支持的版本可以参考Arm Development Studio User Guide的 <a class="reference external" href="https://developer.arm.com/documentation/101470/2024-0/Debugging-Embedded-Systems/About-OS-awareness">About OS awareness</a></p>
<p>可以看到这里支持的版本非常有限，如果使用的kernel不在上面的列表里面 …</p>
                <a class="readmore" href="../posts/2024/07/03_debug_kernel_module.html">read more</a>
<p><a href="https://geesun.github.io/posts/2024/07/03_debug_kernel_module.html#disqus_thread">comments</a></p>                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="../posts/2024/07/02_kasan.html" rel="bookmark"
                           title="Permalink to Kasan 使用">Kasan 使用</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <span>一 22 七月 2024</span>
<span>| tags: <a href="../tag/linux.html">Linux</a><a href="../tag/debug.html">Debug</a></span>
</footer><!-- /.post-info -->                <p>KASAN(Kernel Address Sanitizer)是一个在kernel里面检测内存越界访问的一个工具，可以检测</p>
<ul class="simple">
<li>全局变量越界 (仅Generic KASAN支持)</li>
<li>栈变量的越界 (仅Generic KASAN和Software Tag-Based KASAN支持)</li>
<li>SLAB 分配器分配的object</li>
<li>PAGE 分配器分配的Page</li>
<li>Vmalloc …</li></ul>
                <a class="readmore" href="../posts/2024/07/02_kasan.html">read more</a>
<p><a href="https://geesun.github.io/posts/2024/07/02_kasan.html#disqus_thread">comments</a></p>                </div><!-- /.entry-content -->
            </article></li>
            </ol><!-- /#posts-list -->
<nav>
  <ul>
    <li>Page 1 / 7</li>
        <li><a href="../category/linux2.html">&rang;</a></li>
        <li><a href="../category/linux7.html">&Rang;</a></li>
  </ul>
</nav>
            </section><!-- /#content -->

        <footer id="contentinfo" class="body">
                <p>&copy; 2024 Qixiang Xu</p>
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'geesun';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>