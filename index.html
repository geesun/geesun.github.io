<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å—å·ä¹ŒçŸ³å¾æ°æ—è°± - è´æˆ¿ç¼æ”¯éƒ­å®¶å…æ”¯ç³»</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft YaHei", "PingFang SC", sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            overflow: hidden;
        }

        #header {
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 100;
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        }
        
        #header.hidden {
            max-height: 0;
            padding: 0 20px;
        }

        #header h1 {
            font-size: 18px;
            color: #2c3e50;
            margin: 0;
        }

        #header .stats {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: #666;
        }

        #header .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #header .stat-value {
            font-size: 16px;
            font-weight: bold;
            color: #3498db;
        }

        #controls {
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        }
        
        #controls.hidden {
            max-height: 0;
            padding: 0 15px;
        }
        
        #fullscreen-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(52, 152, 219, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 150;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #fullscreen-btn:hover {
            background: rgba(41, 128, 185, 0.95);
            transform: scale(1.1);
        }

        #controls button {
            padding: 6px 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        #controls button:hover {
            background: #2980b9;
        }

        #search-box {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
            width: 180px;
        }

        #tree-container {
            width: 100%;
            height: calc(100vh - 95px);
            position: relative;
            overflow: hidden;
            transition: height 0.3s ease-out;
        }
        
        #tree-container.expanded {
            height: 100vh;
        }

        .node rect {
            cursor: pointer;
            transition: all 0.3s;
        }

        .node rect:hover {
            fill: #e8f4f8 !important;
            stroke: #2980b9 !important;
            stroke-width: 3px !important;
        }

        .node.selected circle {
            fill: #e74c3c;
            stroke: #c0392b;
        }

        .node text {
            font-size: 13px;
            font-weight: bold;
            pointer-events: none;
        }

        .node .name-text {
            fill: #2c3e50;
            font-size: 14px;
        }

        .node .gen-text {
            fill: #7f8c8d;
            font-size: 11px;
            font-weight: normal;
        }

        .node .note-text {
            fill: #95a5a6;
            font-size: 10px;
            font-weight: normal;
            font-style: italic;
        }

        .link {
            fill: none;
            stroke: #95a5a6;
            stroke-width: 2px;
        }

        #detail-card {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            padding: 25px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }
        
        /* ç§»åŠ¨ç«¯æ ·å¼ */
        @media (max-width: 768px) {
            #detail-card {
                max-width: 90vw;
                max-height: 85vh;
                padding: 20px;
            }
            
            #detail-card h2 {
                font-size: 18px;
            }
            
            #detail-card .section-title {
                font-size: 14px;
            }
            
            #detail-card .info-row {
                font-size: 13px;
            }
        }

        #detail-card.show {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -45%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }

        #detail-card .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
        }

        #detail-card .close-btn:hover {
            background: #c0392b;
        }

        #detail-card h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
        }

        #detail-card .section {
            margin: 20px 0;
        }

        #detail-card .section-title {
            font-weight: bold;
            color: #3498db;
            margin-bottom: 8px;
            font-size: 16px;
        }

        #detail-card .info-row {
            margin: 8px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            line-height: 1.6;
        }

        #detail-card .label {
            color: #7f8c8d;
            font-weight: bold;
            margin-right: 8px;
        }

        #detail-card .children-list,
        #detail-card .siblings-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        #detail-card .person-tag {
            display: inline-block;
            padding: 4px 12px;
            background: #ecf0f1;
            border-radius: 12px;
            font-size: 13px;
            color: #2c3e50;
            border: 1px solid #bdc3c7;
        }

        #detail-card .person-tag.current {
            background: #e74c3c;
            color: white;
            border-color: #c0392b;
        }

        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 999;
        }

        #overlay.show {
            display: block;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20px;
            color: #3498db;
        }

        .tooltip {
            position: absolute;
            background: rgba(44, 62, 80, 0.95);
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 13px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 100;
            max-width: 250px;
            line-height: 1.6;
        }

        .tooltip.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>ğŸŒ³å—å·ä¹ŒçŸ³å¾æ°æ—è°± - è´æˆ¿ç¼æ”¯éƒ­å®¶å…æ”¯ç³»</h1>
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="total-people">-</div>
                <div>æ€»äººæ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="generation-range">-</div>
                <div>ä¸–ä»£èŒƒå›´</div>
            </div>
        </div>
    </div>

    <div id="controls">
        <button onclick="resetView()">ğŸ  é‡ç½®è§†å›¾</button>
        <button onclick="expandAll()">â• å±•å¼€å…¨éƒ¨</button>
        <input type="text" id="search-box" placeholder="æœç´¢å§“å..." oninput="searchPerson(this.value)">
        <span id="search-result"></span>
    </div>

    <div id="tree-container"></div>
    
    <button id="fullscreen-btn" onclick="toggleFullscreen()" title="å…¨å±/é€€å‡ºå…¨å±">â›¶</button>

    <div id="overlay" onclick="closeDetailCard()"></div>
    
    <div id="detail-card">
        <button class="close-btn" onclick="closeDetailCard()">Ã—</button>
        <div id="detail-content"></div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        let treeData = null;
        let allPeople = [];
        let root = null;
        let svg = null;
        let g = null;
        let tree = null;
        let selectedNode = null;
        let zoom = null;  // å…¨å±€zoomå®ä¾‹

        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                const response = await fetch('family_tree_full.json');
                const data = await response.json();
                allPeople = data;
                
                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                document.getElementById('total-people').textContent = data.length;
                const generations = data.map(p => p.generation).filter(g => g);
                const minGen = Math.min(...generations);
                const maxGen = Math.max(...generations);
                document.getElementById('generation-range').textContent = `${minGen}-${maxGen}ä¸–`;
                
                // æ„å»ºæ ‘å½¢ç»“æ„
                buildTree(data);
                initTree();
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                alert('åŠ è½½æ—è°±æ•°æ®å¤±è´¥ï¼Œè¯·ç¡®ä¿ family_tree_full.json æ–‡ä»¶å­˜åœ¨');
            }
        }

        // æ„å»ºæ ‘å½¢ç»“æ„
        function buildTree(people) {
            const peopleMap = {};
            people.forEach(p => peopleMap[p.nid] = {...p, children: []});
            
            // æ‰¾åˆ°æ ¹èŠ‚ç‚¹ï¼ˆæ²¡æœ‰çˆ¶äº²çš„æœ€æ—©ä¸–ä»£ï¼‰
            let roots = [];
            people.forEach(person => {
                if (!person.father || !peopleMap[person.father.nid]) {
                    roots.push(person);
                }
            });
            
            // æŒ‰ä¸–ä»£æ’åºï¼Œå–æœ€æ—©çš„ä½œä¸ºæ ¹
            roots.sort((a, b) => (a.generation || 999) - (b.generation || 999));
            const rootPerson = roots[0];
            
            // æ„å»ºçˆ¶å­å…³ç³»
            people.forEach(person => {
                if (person.father && peopleMap[person.father.nid]) {
                    peopleMap[person.father.nid].children.push(peopleMap[person.nid]);
                }
            });
            
            treeData = peopleMap[rootPerson.nid];
        }

        // åˆå§‹åŒ–æ ‘å½¢å›¾
        function initTree() {
            const container = document.getElementById('tree-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            svg = d3.select('#tree-container')
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            g = svg.append('g');
            
            // æ·»åŠ ç¼©æ”¾å’Œæ‹–æ‹½
            zoom = d3.zoom()
                .scaleExtent([0.1, 3])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });
            
            svg.call(zoom);
            
            // ä½¿ç”¨ nodeSize è€Œä¸æ˜¯ sizeï¼Œç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹æœ‰å›ºå®šç©ºé—´
            // å·¦å³å¸ƒå±€: [å‚ç›´é—´è·, æ°´å¹³é—´è·]
            tree = d3.tree()
                .nodeSize([100, 180]);
            
            root = d3.hierarchy(treeData);
            root.x0 = 0;
            root.y0 = 0;
            
            // é»˜è®¤æŠ˜å æ·±åº¦å¤§äº2çš„èŠ‚ç‚¹
            root.children.forEach(collapse);
            
            // å…ˆæ›´æ–°æ˜¾ç¤ºèŠ‚ç‚¹
            update(root);
            
            // ç­‰å¾…DOMæ›´æ–°åå±…ä¸­æ˜¾ç¤º
            setTimeout(() => centerNode(root), 300);
        }

        // å±…ä¸­æ˜¾ç¤ºæŒ‡å®šèŠ‚ç‚¹
        function centerNode(source) {
            const container = document.getElementById('tree-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            const scale = 0.85;
            // ä½¿ç”¨å½“å‰ä½ç½® d.y å’Œ d.xï¼Œè€Œä¸æ˜¯æ—§ä½ç½® d.y0 å’Œ d.x0
            const x = -source.y * scale + 150;
            const y = -source.x * scale + height / 2;
            
            const transform = d3.zoomIdentity.translate(x, y).scale(scale);
            svg.transition().duration(750).call(zoom.transform, transform);
        }

        // æŠ˜å èŠ‚ç‚¹
        function collapse(d) {
            if (d.children) {
                d._children = d.children;
                d._children.forEach(collapse);
                d.children = null;
            }
        }

        // æ›´æ–°æ ‘å½¢å›¾
        function update(source) {
            const duration = 300;
            const treeLayout = tree(root);
            const nodes = treeLayout.descendants();
            const links = treeLayout.links();
            
            // nodeSize ä¼šè‡ªåŠ¨è®¡ç®—ä½ç½®ï¼Œä¸éœ€è¦æ‰‹åŠ¨è®¾ç½® y
            
            // æ›´æ–°èŠ‚ç‚¹
            const node = g.selectAll('.node')
                .data(nodes, d => d.data.nid);
            
            // æ–°èŠ‚ç‚¹
            const nodeEnter = node.enter().append('g')
                .attr('class', 'node')
                .attr('transform', d => `translate(${source.y0},${source.x0})`)
                .on('click', (event, d) => {
                    if (event.shiftKey) {
                        showDetailCard(d.data);
                    } else {
                        // å…ˆå±…ä¸­è¯¥èŠ‚ç‚¹
                        centerNode(d);
                        // å»¶è¿Ÿä¸€ç‚¹å†å±•å¼€ï¼Œè®©å±…ä¸­åŠ¨ç”»å…ˆå®Œæˆ
                        setTimeout(() => {
                            toggle(d);
                            update(d);
                        }, 400);
                    }
                })
                .on('contextmenu', (event, d) => {
                    // å³é”®ç‚¹å‡»æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼ˆç§»åŠ¨ç«¯é•¿æŒ‰ä¼šè§¦å‘ï¼‰
                    event.preventDefault();
                    showDetailCard(d.data);
                })
                .on('touchstart', (event, d) => {
                    // ç§»åŠ¨ç«¯é•¿æŒ‰æ£€æµ‹
                    const touchTimer = setTimeout(() => {
                        showDetailCard(d.data);
                    }, 500);
                    d3.select(event.currentTarget).attr('data-touch-timer', touchTimer);
                })
                .on('touchend', (event, d) => {
                    // å–æ¶ˆé•¿æŒ‰è®¡æ—¶å™¨
                    const touchTimer = d3.select(event.currentTarget).attr('data-touch-timer');
                    if (touchTimer) {
                        clearTimeout(touchTimer);
                    }
                })
                .on('touchmove', (event, d) => {
                    // ç§»åŠ¨æ—¶å–æ¶ˆé•¿æŒ‰
                    const touchTimer = d3.select(event.currentTarget).attr('data-touch-timer');
                    if (touchTimer) {
                        clearTimeout(touchTimer);
                    }
                })
                .on('mouseover', (event, d) => showTooltip(event, d.data))
                .on('mouseout', hideTooltip);
            
            // åœ†è§’çŸ©å½¢
            nodeEnter.append('rect')
                .attr('width', 60)
                .attr('height', 30)
                .attr('x', -30)
                .attr('y', -15)
                .attr('rx', 5)
                .attr('ry', 5)
                .style('fill', '#fff')
                .style('stroke', '#3498db')
                .style('stroke-width', '2px');
            
            // å§“åï¼ˆåœ¨æ–¹æ¡†å†…ï¼‰
            nodeEnter.append('text')
                .attr('class', 'name-text')
                .attr('dy', 5)
                .style('text-anchor', 'middle')
                .text(d => d.data.name);
            
            // ä¸–ä»£ï¼ˆåœ¨æ–¹æ¡†ä¸Šæ–¹ï¼‰
            nodeEnter.append('text')
                .attr('class', 'gen-text')
                .attr('dy', -20)
                .style('text-anchor', 'middle')
                .text(d => d.data.generation ? `ç¬¬${d.data.generation}ä¸–` : '');
            
            // å¤‡æ³¨ï¼ˆåœ¨æ–¹æ¡†ä¸‹æ–¹ï¼Œå°å­—ä½“ï¼‰
            nodeEnter.append('text')
                .attr('class', 'note-text')
                .attr('dy', 30)
                .style('text-anchor', 'middle')
                .text(d => {
                    if (!d.data.note) return '';
                    return d.data.note.length > 8 ? d.data.note.substring(0, 8) + '...' : d.data.note;
                });
            
            // æ›´æ–°èŠ‚ç‚¹ä½ç½®ï¼ˆæ°´å¹³å¸ƒå±€ï¼šyæ˜¯æ°´å¹³ï¼Œxæ˜¯å‚ç›´ï¼‰
            const nodeUpdate = nodeEnter.merge(node);
            nodeUpdate.transition()
                .duration(duration)
                .attr('transform', d => `translate(${d.y},${d.x})`);
            
            // ç§»é™¤æ—§èŠ‚ç‚¹
            node.exit().transition()
                .duration(duration)
                .attr('transform', d => `translate(${source.y},${source.x})`)
                .remove();
            
            // æ›´æ–°è¿çº¿
            const link = g.selectAll('.link')
                .data(links, d => d.target.data.nid);
            
            const linkEnter = link.enter().insert('path', 'g')
                .attr('class', 'link')
                .attr('d', d => {
                    const o = {x: source.x0, y: source.y0};
                    return diagonal(o, o);
                });
            
            linkEnter.merge(link).transition()
                .duration(duration)
                .attr('d', d => diagonal(d.source, d.target));
            
            link.exit().transition()
                .duration(duration)
                .attr('d', d => {
                    const o = {x: source.x, y: source.y};
                    return diagonal(o, o);
                })
                .remove();
            
            // ä¿å­˜æ—§ä½ç½®
            nodes.forEach(d => {
                d.x0 = d.x;
                d.y0 = d.y;
            });
        }

        // å¯¹è§’çº¿è¿æ¥ï¼ˆæ°´å¹³æ–¹å‘ï¼‰
        function diagonal(s, d) {
            return `M ${s.y} ${s.x}
                    C ${(s.y + d.y) / 2} ${s.x},
                      ${(s.y + d.y) / 2} ${d.x},
                      ${d.y} ${d.x}`;
        }

        // åˆ‡æ¢èŠ‚ç‚¹å±•å¼€/æŠ˜å 
        function toggle(d) {
            if (d.children) {
                d._children = d.children;
                d.children = null;
            } else {
                d.children = d._children;
                d._children = null;
            }
        }

        // æ˜¾ç¤ºæç¤ºæ¡†
        function showTooltip(event, data) {
            const tooltip = document.getElementById('tooltip');
            let html = `<strong>${data.name}</strong><br>`;
            if (data.generation) html += `ç¬¬${data.generation}ä¸–<br>`;
            if (data.note) html += `${data.note}<br>`;
            if (data.father) html += `çˆ¶: ${data.father.name}<br>`;
            if (data.children.length > 0) html += `å­å¥³: ${data.children.length}äºº<br>`;
            html += `<em>Shift+ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</em>`;
            
            tooltip.innerHTML = html;
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY + 10) + 'px';
            tooltip.classList.add('show');
        }

        function hideTooltip() {
            document.getElementById('tooltip').classList.remove('show');
        }

        // æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯å¡ç‰‡
        function showDetailCard(person) {
            const card = document.getElementById('detail-card');
            const content = document.getElementById('detail-content');
            
            let html = `<h2>${person.name} ${person.generation ? `(ç¬¬${person.generation}ä¸–)` : ''}</h2>`;
            
            // åŸºæœ¬ä¿¡æ¯
            html += `<div class="section">`;
            html += `<div class="section-title">ğŸ“‹ åŸºæœ¬ä¿¡æ¯</div>`;
            if (person.note) html += `<div class="info-row"><span class="label">å¤‡æ³¨:</span>${person.note}</div>`;
            if (person.relation_to_father) html += `<div class="info-row"><span class="label">æ’è¡Œ:</span>${person.relation_to_father}</div>`;
            html += `</div>`;
            
            // çˆ¶äº²
            if (person.father) {
                html += `<div class="section">`;
                html += `<div class="section-title">ğŸ‘¨ çˆ¶äº²</div>`;
                html += `<div class="info-row">${person.father.name}</div>`;
                html += `</div>`;
            }
            
            // å­å¥³
            if (person.children && person.children.length > 0) {
                html += `<div class="section">`;
                html += `<div class="section-title">ğŸ‘¶ å­å¥³ (${person.children.length}äºº)</div>`;
                html += `<div class="children-list">`;
                person.children.forEach(child => {
                    html += `<span class="person-tag">${child.relation || ''} ${child.name}</span>`;
                });
                html += `</div></div>`;
            }
            
            // å…„å¼Ÿå§å¦¹
            if (person.siblings && person.siblings.list) {
                html += `<div class="section">`;
                html += `<div class="section-title">ğŸ‘¥ å…„å¼Ÿå§å¦¹ (${person.siblings.total_count}äºº)</div>`;
                html += `<div class="siblings-list">`;
                person.siblings.list.forEach(sibling => {
                    const isCurrent = sibling.includes(person.name);
                    html += `<span class="person-tag ${isCurrent ? 'current' : ''}">${sibling}</span>`;
                });
                html += `</div></div>`;
            }
            
            // è¯¦ç»†æè¿°
            if (person.detail_info && person.detail_info.raw_text) {
                html += `<div class="section">`;
                html += `<div class="section-title">ğŸ“œ è¯¦ç»†ä¿¡æ¯</div>`;
                html += `<div class="info-row" style="white-space: pre-wrap;">${person.detail_info.raw_text}</div>`;
                html += `</div>`;
            }
            
            // è®³å·
            if (person.detail_info && (person.detail_info.aliases.hui || person.detail_info.aliases.hao)) {
                html += `<div class="section">`;
                html += `<div class="section-title">ğŸ·ï¸ è®³å·</div>`;
                if (person.detail_info.aliases.hui) {
                    html += `<div class="info-row"><span class="label">è®³:</span>${person.detail_info.aliases.hui}</div>`;
                }
                if (person.detail_info.aliases.hao) {
                    html += `<div class="info-row"><span class="label">å·:</span>${person.detail_info.aliases.hao}</div>`;
                }
                html += `</div>`;
            }
            
            // ç”Ÿå’ä¿¡æ¯
            if (person.detail_info && (person.detail_info.birth || person.detail_info.death)) {
                html += `<div class="section">`;
                html += `<div class="section-title">â³ ç”Ÿå’ä¿¡æ¯</div>`;
                if (person.detail_info.birth) {
                    html += `<div class="info-row"><span class="label">ç”Ÿ:</span>${person.detail_info.birth}</div>`;
                }
                if (person.detail_info.death) {
                    html += `<div class="info-row"><span class="label">æ®:</span>${person.detail_info.death}</div>`;
                }
                if (person.detail_info.burial) {
                    html += `<div class="info-row"><span class="label">è‘¬:</span>${person.detail_info.burial}</div>`;
                }
                html += `</div>`;
            }
            
            content.innerHTML = html;
            card.classList.add('show');
            document.getElementById('overlay').classList.add('show');
        }

        function closeDetailCard() {
            document.getElementById('detail-card').classList.remove('show');
            document.getElementById('overlay').classList.remove('show');
        }

        // é‡ç½®è§†å›¾
        function resetView() {
            // é‡æ–°å±•å¼€æ‰€æœ‰èŠ‚ç‚¹
            root.each(d => {
                if (d._children) {
                    d.children = d._children;
                    d._children = null;
                }
            });
            
            // ç„¶åæŠ˜å æ·±åº¦å¤§äº2çš„èŠ‚ç‚¹ï¼ˆæ¢å¤åˆ°åˆå§‹çŠ¶æ€ï¼‰
            if (root.children) {
                root.children.forEach(collapse);
            }
            
            // æ›´æ–°æ˜¾ç¤º
            update(root);
            
            // å»¶è¿Ÿåå±…ä¸­
            setTimeout(() => centerNode(root), 300);
        }
        
        // å®Œå…¨æŠ˜å èŠ‚ç‚¹åŠå…¶æ‰€æœ‰å­èŠ‚ç‚¹
        function collapseAll(d) {
            if (d.children) {
                d._children = d.children;
                d._children.forEach(collapseAll);
                d.children = null;
            }
        }

        // å±•å¼€å…¨éƒ¨
        function expandAll() {
            root.each(d => {
                if (d._children) {
                    d.children = d._children;
                    d._children = null;
                }
            });
            update(root);
        }

        // æœç´¢äººå‘˜
        function searchPerson(query) {
            const result = document.getElementById('search-result');
            if (!query) {
                result.textContent = '';
                return;
            }
            
            const matches = allPeople.filter(p => p.name.includes(query));
            result.textContent = matches.length > 0 ? `æ‰¾åˆ° ${matches.length} äºº` : 'æœªæ‰¾åˆ°';
            
            if (matches.length > 0) {
                // æ‰¾åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…çš„äººåœ¨æ ‘ä¸­çš„èŠ‚ç‚¹
                const person = matches[0];
                const found = findNodeByNid(root, person.nid);
                
                if (found) {
                    // å±•å¼€ä»æ ¹èŠ‚ç‚¹åˆ°ç›®æ ‡èŠ‚ç‚¹çš„è·¯å¾„
                    expandPathToNode(found);
                    // æ›´æ–°è§†å›¾
                    update(root);
                    // å±…ä¸­æ˜¾ç¤ºç›®æ ‡èŠ‚ç‚¹
                    centerNode(found);
                    // é«˜äº®æ˜¾ç¤º
                    highlightPerson(person.nid);
                }
            }
        }
        
        // æ ¹æ®nidæŸ¥æ‰¾èŠ‚ç‚¹
        function findNodeByNid(current, nid) {
            if (current.data.nid === nid) {
                return current;
            }
            
            const children = current.children || current._children;
            if (children) {
                for (let child of children) {
                    const found = findNodeByNid(child, nid);
                    if (found) return found;
                }
            }
            
            return null;
        }
        
        // å±•å¼€ä»æ ¹èŠ‚ç‚¹åˆ°ç›®æ ‡èŠ‚ç‚¹çš„è·¯å¾„
        function expandPathToNode(target) {
            // æ‰¾åˆ°ä»æ ¹åˆ°ç›®æ ‡çš„è·¯å¾„
            const path = [];
            findPath(root, target, path);
            
            // å±•å¼€è·¯å¾„ä¸Šçš„æ‰€æœ‰èŠ‚ç‚¹
            path.forEach(node => {
                if (node._children) {
                    node.children = node._children;
                    node._children = null;
                }
            });
        }
        
        // æŸ¥æ‰¾ä»æ ¹èŠ‚ç‚¹åˆ°ç›®æ ‡èŠ‚ç‚¹çš„è·¯å¾„
        function findPath(current, target, path) {
            path.push(current);
            
            if (current === target) {
                return true;
            }
            
            const children = current.children || current._children;
            if (children) {
                for (let child of children) {
                    if (findPath(child, target, path)) {
                        return true;
                    }
                }
            }
            
            path.pop();
            return false;
        }

        // é«˜äº®æ˜¾ç¤ºæŒ‡å®šäººå‘˜
        function highlightPerson(nid) {
            d3.selectAll('.node').classed('selected', false);
            d3.selectAll('.node').filter(d => d.data.nid === nid).classed('selected', true);
        }

        // åˆ‡æ¢å…¨å±æ¨¡å¼
        function toggleFullscreen() {
            const header = document.getElementById('header');
            const controls = document.getElementById('controls');
            const treeContainer = document.getElementById('tree-container');
            const btn = document.getElementById('fullscreen-btn');
            
            header.classList.toggle('hidden');
            controls.classList.toggle('hidden');
            treeContainer.classList.toggle('expanded');
            
            // æ”¹å˜æŒ‰é’®å›¾æ ‡
            if (header.classList.contains('hidden')) {
                btn.textContent = 'âœ–';  // é€€å‡ºå…¨å±
            } else {
                btn.textContent = 'â›¶';  // å…¨å±
            }
            
            // è°ƒæ•´SVGå¤§å°ä»¥é€‚åº”æ–°çš„å®¹å™¨å°ºå¯¸
            setTimeout(() => {
                const width = treeContainer.clientWidth;
                const height = treeContainer.clientHeight;
                if (svg) {
                    svg.attr('width', width).attr('height', height);
                }
            }, 350);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', loadData);
    </script>
</body>
</html>
